# 后端系统完整文档

## 文档索引

### 1. [项目概述](./01_PROJECT_OVERVIEW.md)
- 项目简介
- 技术栈
- 项目结构
- 核心功能模块
- 环境配置
- API文档
- 认证方式
- 数据库模型
- 安全特性
- 性能优化
- 部署说明

### 2. [用户模块](./02_USERS_MODULE.md)
- 数据模型（User, Address）
- API端点
  - 微信小程序登录
  - 管理员密码登录
  - 用户资料管理
  - 收货地址管理
  - 地址智能解析
  - 管理员用户管理
- 序列化器
- 权限控制
- 限流策略
- 缓存策略
- 安全特性

### 3. [商品目录模块](./03_CATALOG_MODULE.md)
- 数据模型（Product, Category, Brand, ProductImage, Favorite, Cart）
- API端点
  - 商品管理
  - 分类管理
  - 品牌管理
  - 商品搜索
  - 收藏功能
  - 购物车功能
- 搜索功能
- 文件上传
- 缓存策略

### 4. [订单模块](./04_ORDERS_MODULE.md)
- 数据模型（Order, OrderItem, Payment）
- API端点
  - 订单创建
  - 订单查询
  - 订单状态管理
  - 支付处理
  - 订单统计
- 状态机
- 支付服务
- 订单分析
- 定时任务

### 5. [海尔API集成](./05_INTEGRATIONS_MODULE.md)
- 海尔OAuth2.0 API
  - 认证
  - 商品查询
  - 价格查询
  - 库存查询
  - 物流查询
  - 余额查询
- 易理货系统API
  - 订单创建
  - 订单取消
  - 订单改约
  - 配送照片
  - 物流单号查询
- 配置管理
- 同步日志

### 6. [公共工具模块](./06_COMMON_MODULE.md)
- 异常处理
- 日志配置
- 分页器
- 权限控制
- 限流器
- 地址解析器
- 审计日志
- 响应格式
- 健康检查

### 7. [API参考](./07_API_REFERENCE.md)
- 完整API列表
- 请求/响应示例
- 错误码说明
- 认证方式
- 限流规则

### 8. [数据库设计](./08_DATABASE_DESIGN.md)
- ER图
- 表结构详解
- 索引设计
- 关系说明
- 迁移历史

### 9. [部署指南](./09_DEPLOYMENT_GUIDE.md)
- 环境准备
- 配置说明
- 数据库迁移
- 静态文件
- 日志配置
- 监控告警
- 备份恢复

### 10. [开发指南](./10_DEVELOPMENT_GUIDE.md)
- 开发环境搭建
- 代码规范
- 测试指南
- 调试技巧
- Git工作流
- 常见问题

## 快速开始

### 1. 安装依赖
```bash
cd backend
pip install -r requirements.txt
```

### 2. 配置环境变量
```bash
cp .env.example .env
# 编辑.env文件，填写必要的配置
```

### 3. 数据库迁移
```bash
python manage.py migrate
```

### 4. 创建超级用户
```bash
python manage.py createsuperuser
```

### 5. 运行开发服务器
```bash
python manage.py runserver
```

### 6. 访问API文档
- Swagger UI: http://localhost:8000/api/docs/
- ReDoc: http://localhost:8000/api/redoc/
- Admin: http://localhost:8000/admin/

## 核心概念

### 认证流程
1. 微信小程序用户：通过微信code登录
2. 管理员用户：通过用户名密码登录
3. 获取JWT token
4. 在请求头中携带token访问API

### 权限系统
- AllowAny: 允许所有用户
- IsAuthenticated: 需要登录
- IsOwnerOrAdmin: 资源所有者或管理员
- IsAdmin: 仅管理员

### 数据流转
```
前端 → API → 视图 → 序列化器 → 模型 → 数据库
                ↓
            业务逻辑
                ↓
            第三方API（海尔）
```

## 技术亮点

### 1. 双认证系统
- 支持微信小程序登录
- 支持管理员密码登录
- 统一的JWT token管理

### 2. 海尔API集成
- OAuth2.0认证
- 自动token刷新
- 错误重试机制
- 详细日志记录

### 3. 智能地址解析
- 自动识别省市区
- 支持多种地址格式
- 正则表达式匹配

### 4. 订单状态机
- 严格的状态转换规则
- 防止非法状态变更
- 状态变更日志

### 5. 性能优化
- 查询优化（select_related, prefetch_related）
- 缓存策略（用户统计、商品列表）
- 数据库索引
- 分页加载

### 6. 安全防护
- JWT认证
- CSRF保护
- XSS防护
- SQL注入防护
- 限流保护
- 审计日志

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      前端应用                            │
│              (微信小程序 + 商户管理后台)                  │
└─────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/REST API
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    Django REST Framework                 │
│  ┌──────────┬──────────┬──────────┬──────────────────┐  │
│  │  Users   │ Catalog  │  Orders  │  Integrations   │  │
│  │  模块    │  模块    │  模块    │     模块        │  │
│  └──────────┴──────────┴──────────┴──────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Common (公共工具)                    │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ↓                   ↓                   ↓
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   Database   │   │  File Storage│   │  Third-party │
│  (SQLite/    │   │   (Local/    │   │     APIs     │
│  PostgreSQL) │   │     CDN)     │   │   (海尔API)  │
└──────────────┘   └──────────────┘   └──────────────┘
```

## 数据流示例

### 用户下单流程
```
1. 用户登录 → 获取JWT token
2. 浏览商品 → 查询商品列表
3. 添加购物车 → 创建购物车记录
4. 选择地址 → 查询/创建收货地址
5. 创建订单 → 生成订单记录
6. 发起支付 → 调用微信支付API
7. 支付回调 → 更新订单状态
8. 推送海尔 → 调用海尔API创建订单
9. 查询物流 → 调用海尔API查询物流
10. 确认收货 → 更新订单状态为已完成
```

## 环境对比

| 特性 | 开发环境 | 生产环境 |
|------|---------|---------|
| DEBUG | True | False |
| 数据库 | SQLite | PostgreSQL |
| 缓存 | 本地内存 | Redis（可选） |
| 文件存储 | 本地文件系统 | CDN |
| CORS | 允许所有 | 白名单 |
| 限流 | 关闭 | 开启 |
| 日志级别 | DEBUG | INFO |
| HTTPS | 可选 | 强制 |

## 性能指标

### 响应时间
- API平均响应时间: < 200ms
- 数据库查询时间: < 50ms
- 缓存命中率: > 80%

### 并发能力
- 支持并发请求: 1000+
- 数据库连接池: 20
- 限流保护: 100请求/分钟/用户

### 可用性
- 目标可用性: 99.9%
- 健康检查: /healthz
- 自动重启: 支持

## 监控和告警

### 监控指标
- API响应时间
- 错误率
- 数据库性能
- 缓存命中率
- 磁盘使用率

### 日志分析
- 访问日志
- 错误日志
- 慢查询日志
- 支付审计日志

### 告警规则
- 错误率 > 5%
- 响应时间 > 1s
- 磁盘使用 > 80%
- 数据库连接数 > 80%

## 维护和升级

### 日常维护
- 日志清理
- 数据库备份
- 性能监控
- 安全更新

### 版本升级
- 数据库迁移
- 依赖更新
- 配置变更
- 回滚方案

## 联系方式

- 技术支持: support@example.com
- 问题反馈: GitHub Issues
- 文档更新: 提交PR

## 许可证

MIT License

## 更新日志

参考各模块的CHANGELOG.md文件
