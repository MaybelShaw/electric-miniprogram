# 商品业务逻辑

<cite>
**本文档引用的文件**
- [models.py](file://backend/catalog/models.py)
- [views.py](file://backend/catalog/views.py)
- [haierapi.py](file://backend/integrations/haierapi.py)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py)
- [serializers.py](file://backend/catalog/serializers.py)
- [permissions.py](file://backend/common/permissions.py)
- [search.py](file://backend/catalog/search.py)
- [state_machine.py](file://backend/orders/state_machine.py)
- [analytics.py](file://backend/orders/analytics.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心数据模型](#核心数据模型)
4. [商品管理业务流程](#商品管理业务流程)
5. [海尔API集成](#海尔api集成)
6. [商品状态管理](#商品状态管理)
7. [销售统计与浏览统计](#销售统计与浏览统计)
8. [权限控制与安全](#权限控制与安全)
9. [错误处理与日志记录](#错误处理与日志记录)
10. [性能优化策略](#性能优化策略)
11. [常见问题与解决方案](#常见问题与解决方案)
12. [总结](#总结)

## 简介

本文档详细介绍了电动小程序项目中的商品业务逻辑，重点阐述了商品管理的核心业务流程，包括商品的创建、更新、删除操作，以及与海尔API的深度集成。系统采用Django框架构建，实现了完整的商品生命周期管理，支持本地商品和海尔商品的统一管理，并提供了丰富的统计分析功能。

## 项目结构概览

商品业务模块位于`backend/catalog/`目录下，主要包含以下核心组件：

```mermaid
graph TB
subgraph "商品业务模块"
A[models.py<br/>数据模型] --> B[views.py<br/>视图控制器]
B --> C[serializers.py<br/>序列化器]
B --> D[search.py<br/>搜索服务]
E[management/<br/>管理命令] --> F[sync_haier_products.py<br/>海尔同步命令]
G[integrations/<br/>集成模块] --> H[haierapi.py<br/>海尔API客户端]
end
subgraph "前端管理界面"
I[merchant/<br/>商户管理] --> J[Products/<br/>商品管理页面]
K[frontend/<br/>用户前端] --> L[ProductDetail/<br/>商品详情]
end
A --> G
B --> I
B --> K
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L1-L312)
- [views.py](file://backend/catalog/views.py#L1-L980)
- [haierapi.py](file://backend/integrations/haierapi.py#L1-L214)

## 核心数据模型

### Product 商品模型

商品模型是整个业务的核心，包含了商品的基本属性、状态信息和海尔API集成字段：

```mermaid
classDiagram
class Product {
+BigAutoField id
+CharField name
+TextField description
+ForeignKey category
+ForeignKey brand
+DecimalField price
+CharField source
+PositiveIntegerField stock
+CharField product_code
+CharField product_model
+CharField product_group
+DecimalField supply_price
+DecimalField invoice_price
+DecimalField market_price
+DecimalField stock_rebate
+DecimalField rebate_money
+JSONField main_images
+JSONField detail_images
+CharField product_image_url
+JSONField product_page_urls
+BooleanField is_active
+CharField is_sales
+CharField no_sales_reason
+PositiveIntegerField view_count
+PositiveIntegerField sales_count
+CharField warehouse_code
+CharField warehouse_grade
+DateTimeField created_at
+DateTimeField updated_at
+DateTimeField last_sync_at
+sync_from_haier(haier_data, category, brand) Product
+update_stock_from_haier(stock_data) void
+display_price() DecimalField
+is_available_from_haier() BooleanField
}
class Category {
+BigAutoField id
+CharField name
+IntegerField order
+DateTimeField created_at
+DateTimeField updated_at
}
class Brand {
+BigAutoField id
+CharField name
+URLField logo
+TextField description
+IntegerField order
+BooleanField is_active
+DateTimeField created_at
+DateTimeField updated_at
}
Product --> Category : "belongs to"
Product --> Brand : "belongs to"
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L43-L205)

### 关键字段说明

| 字段名 | 类型 | 描述 | 业务意义 |
|--------|------|------|----------|
| `source` | CharField | 商品来源 | 区分本地商品(SOURCE_LOCAL)和海尔商品(SOURCE_HAIER) |
| `is_active` | BooleanField | 是否上架 | 控制商品在前端的可见性 |
| `is_sales` | CharField | 海尔是否可采 | '1'表示可采，'0'表示不可采 |
| `sales_count` | PositiveIntegerField | 销售数量 | 统计商品销售情况 |
| `view_count` | PositiveIntegerField | 浏览次数 | 记录商品被查看的次数 |
| `stock` | PositiveIntegerField | 库存数量 | 当前可用库存 |
| `last_sync_at` | DateTimeField | 最后同步时间 | 记录与海尔API同步的时间 |

**章节来源**
- [models.py](file://backend/catalog/models.py#L43-L116)

## 商品管理业务流程

### 商品创建流程

商品创建遵循严格的业务规则，确保数据的一致性和完整性：

```mermaid
flowchart TD
A[接收创建请求] --> B{验证必填字段}
B --> |缺失| C[返回验证错误]
B --> |完整| D{检查商品来源}
D --> |本地商品| E[创建本地商品]
D --> |海尔商品| F[调用sync_from_haier]
E --> G[设置默认值]
F --> H[从海尔API获取数据]
H --> I[创建或更新商品]
G --> J[保存商品]
I --> J
J --> K[返回创建结果]
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L48-L980)
- [models.py](file://backend/catalog/models.py#L118-L179)

### 商品更新流程

商品更新需要考虑不同来源商品的特殊处理需求：

```mermaid
sequenceDiagram
participant Client as 客户端
participant View as 视图层
participant Model as 模型层
participant API as 海尔API
Client->>View : PUT /api/products/{id}
View->>Model : 获取商品对象
Model-->>View : 返回商品实例
View->>View : 验证权限
View->>View : 验证数据
View->>Model : 保存更新
Model->>Model : 触发信号
Model-->>View : 保存成功
View-->>Client : 返回更新结果
alt 海尔商品且需要同步价格
View->>API : 调用同步价格接口
API-->>View : 返回价格数据
View->>Model : 更新价格信息
end
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L48-L980)
- [models.py](file://backend/catalog/models.py#L181-L195)

### 商品删除流程

商品删除需要考虑关联关系和业务约束：

```mermaid
flowchart TD
A[接收删除请求] --> B{检查关联商品}
B --> |有关联| C{是否强制删除}
C --> |否| D[返回关联警告]
C --> |是| E{检查管理员权限}
E --> |否| F[返回权限错误]
E --> |是| G[执行删除]
B --> |无关联| G
G --> H[删除商品]
H --> I[清理相关数据]
I --> J[返回删除成功]
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L646-L674)

**章节来源**
- [views.py](file://backend/catalog/views.py#L48-L980)

## 海尔API集成

### sync_from_haier 方法详解

`sync_from_haier` 是系统与海尔API集成的核心方法，负责从海尔API同步商品数据：

```mermaid
flowchart TD
A[接收海尔API数据] --> B{验证产品编码}
B --> |无效| C[返回None]
B --> |有效| D[查找或创建商品]
D --> E[更新基本信息]
E --> F{检查价格数据}
F --> |有| G[更新价格字段]
F --> |无| H[保持现有价格]
G --> I{检查品牌信息}
H --> I
I --> |有新品牌| J[创建品牌对象]
I --> |无变化| K[保持现有品牌]
J --> L[更新品牌关联]
K --> L
L --> M[标记为海尔商品]
M --> N[更新同步时间]
N --> O[保存商品]
O --> P[返回商品对象]
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L118-L179)

### update_stock_from_haier 方法

该方法专门处理海尔商品的库存同步：

```mermaid
sequenceDiagram
participant API as 海尔API
participant Method as update_stock_from_haier
participant Model as Product模型
API->>Method : 返回库存数据
Method->>Method : 解析库存信息
Method->>Model : 更新stock字段
Method->>Model : 更新warehouse_code
Method->>Model : 更新warehouse_grade
Method->>Model : 更新last_sync_at
Method->>Model : 保存更改
Model-->>Method : 保存成功
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L181-L195)

### 管理接口实现

系统提供了两个专门的管理接口用于同步海尔商品信息：

| 接口名称 | URL路径 | 权限要求 | 功能描述 |
|----------|---------|----------|----------|
| sync_haier_stock | `/api/products/{id}/sync-haier-stock/` | IsAdmin | 同步指定海尔商品的库存信息 |
| sync_haier_price | `/api/products/{id}/sync-haier-price/` | IsAdmin | 同步指定海尔商品的价格信息 |

**章节来源**
- [models.py](file://backend/catalog/models.py#L118-L195)
- [views.py](file://backend/catalog/views.py#L435-L565)

## 商品状态管理

### 状态字段说明

商品状态管理涉及多个关键字段，每个字段都有特定的业务含义：

```mermaid
stateDiagram-v2
[*] --> 待审核
待审核 --> 已上架 : 管理员审核通过
待审核 --> 已拒绝 : 管理员审核拒绝
已上架 --> 已下架 : 管理员下架
已下架 --> 已上架 : 管理员重新上架
已上架 --> 缺货 : 库存为0
缺货 --> 已上架 : 补充库存
已上架 --> 下架 : 商品停售
下架 --> [*] : 删除商品
已拒绝 --> [*] : 删除商品
```

### is_active 字段控制

`is_active` 字段控制商品在前端的可见性：

- **True**: 商品正常显示，用户可以购买
- **False**: 商品隐藏，用户无法看到
- **应用场景**: 临时下架、维护期间、促销活动等

### is_sales 字段控制

`is_sales` 字段由海尔API提供，控制商品是否可采购：

- **'1'**: 可采，商品可以正常销售
- **'0'**: 不可采，商品暂停销售
- **no_sales_reason**: 不可采原因说明

**章节来源**
- [models.py](file://backend/catalog/models.py#L86-L89)

## 销售统计与浏览统计

### 统计字段设计

系统通过多个统计字段跟踪商品的表现：

| 字段名 | 类型 | 默认值 | 更新时机 | 业务用途 |
|--------|------|--------|----------|----------|
| `view_count` | PositiveIntegerField | 0 | 商品详情访问时 | 统计商品曝光度 |
| `sales_count` | PositiveIntegerField | 0 | 订单完成时 | 统计实际销售量 |
| `created_at` | DateTimeField | 自动 | 商品创建时 | 记录商品上线时间 |
| `updated_at` | DateTimeField | 自动 | 商品更新时 | 记录最后修改时间 |

### 统计更新机制

```mermaid
sequenceDiagram
participant User as 用户
participant Frontend as 前端
participant Backend as 后端
participant Analytics as 统计服务
User->>Frontend : 查看商品详情
Frontend->>Backend : GET /api/products/{id}
Backend->>Backend : 增加view_count
Backend->>Analytics : 记录浏览事件
Backend-->>Frontend : 返回商品信息
User->>Frontend : 购买商品
Frontend->>Backend : 创建订单
Backend->>Backend : 增加sales_count
Backend->>Analytics : 记录销售事件
Backend-->>Frontend : 返回订单结果
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L363-L385)
- [analytics.py](file://backend/orders/analytics.py#L150-L321)

### 推荐算法

系统基于统计信息提供多种推荐策略：

```mermaid
flowchart TD
A[获取商品列表] --> B{推荐类型}
B --> |popular| C[按销售数量排序]
B --> |trending| D[按浏览次数排序]
B --> |category| E[按分类筛选]
C --> F[返回推荐结果]
D --> F
E --> F
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L363-L385)

**章节来源**
- [views.py](file://backend/catalog/views.py#L363-L385)
- [analytics.py](file://backend/orders/analytics.py#L150-L321)

## 权限控制与安全

### 权限层次结构

系统采用多层权限控制机制：

```mermaid
graph TD
A[匿名用户] --> B[只读权限]
C[已认证用户] --> D[部分写权限]
E[管理员] --> F[完全控制权限]
B --> G[商品列表]
B --> H[商品详情]
D --> I[收藏商品]
D --> J[评论商品]
F --> K[创建商品]
F --> L[编辑商品]
F --> M[删除商品]
F --> N[同步海尔数据]
```

**图表来源**
- [permissions.py](file://backend/common/permissions.py#L70-L189)

### 具体权限规则

| 权限类 | GET | POST | PUT | PATCH | DELETE | 特殊要求 |
|--------|-----|------|-----|-------|--------|----------|
| IsAdminOrReadOnly | ✅ | ❌ | ❌ | ❌ | ❌ | 仅管理员可写 |
| IsAdmin | ✅ | ✅ | ✅ | ✅ | ✅ | 必须管理员 |
| IsAuthenticatedOrReadOnly | ✅ | ❌ | ❌ | ❌ | ❌ | 已认证用户可写 |

**章节来源**
- [permissions.py](file://backend/common/permissions.py#L70-L189)
- [views.py](file://backend/catalog/views.py#L29-L51)

## 错误处理与日志记录

### 异常处理策略

系统采用多层次的异常处理机制：

```mermaid
flowchart TD
A[业务操作] --> B{捕获异常}
B --> |数据库异常| C[记录数据库错误]
B --> |网络异常| D[记录网络错误]
B --> |业务异常| E[记录业务错误]
B --> |未知异常| F[记录通用错误]
C --> G[返回友好错误信息]
D --> G
E --> G
F --> G
G --> H[触发告警机制]
G --> I[更新监控指标]
```

### 日志记录规范

系统在关键业务节点记录详细的日志信息：

| 日志级别 | 记录场景 | 示例信息 |
|----------|----------|----------|
| DEBUG | 详细操作过程 | "同步海尔商品: NQ0054000 成功" |
| INFO | 重要业务事件 | "商品创建: iPhone 15 Pro Max" |
| WARNING | 异常但可恢复 | "海尔API连接超时，重试中..." |
| ERROR | 严重错误 | "商品更新失败: 数据库约束违反" |
| CRITICAL | 系统级错误 | "海尔API认证失败，服务不可用" |

**章节来源**
- [views.py](file://backend/catalog/views.py#L487-L493)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L147-L151)

## 性能优化策略

### 查询优化

系统采用多种查询优化技术：

```mermaid
graph LR
A[原始查询] --> B[添加索引]
B --> C[使用select_related]
C --> D[使用prefetch_related]
D --> E[添加缓存]
E --> F[最终优化查询]
```

### 缓存策略

| 缓存类型 | 缓存内容 | 过期时间 | 更新触发 |
|----------|----------|----------|----------|
| 页面缓存 | 商品列表页 | 5分钟 | 商品更新时 |
| 数据缓存 | 热门商品 | 10分钟 | 销售统计变化 |
| 查询缓存 | 分类数据 | 永久 | 分类结构变化 |
| 用户缓存 | 用户统计数据 | 5分钟 | 用户行为变化 |

### 索引优化

商品模型的关键索引设计：

```mermaid
erDiagram
Product {
bool is_active
int sales_count
int view_count
datetime created_at
char source
bigint category_id
bigint brand_id
char is_sales
}
Product ||--|| Category : "category_id"
Product ||--|| Brand : "brand_id"
Product ||--o{ InventoryLog : "inventory_logs"
Product ||--o{ SearchLog : "search_logs"
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L105-L113)

**章节来源**
- [models.py](file://backend/catalog/models.py#L105-L113)
- [views.py](file://backend/catalog/views.py#L52-L67)

## 常见问题与解决方案

### 同步失败处理

当海尔API同步失败时，系统采用以下策略：

```mermaid
flowchart TD
A[同步请求] --> B{API响应}
B --> |成功| C[更新本地数据]
B --> |失败| D{错误类型}
D --> |网络错误| E[重试机制]
D --> |认证错误| F[重新认证]
D --> |数据错误| G[记录错误日志]
E --> H{重试次数}
H --> |未超限| I[延迟重试]
H --> |超限| J[标记失败]
F --> K{认证成功}
K --> |是| A
K --> |否| L[返回认证失败]
C --> M[更新成功]
G --> N[返回错误信息]
I --> A
J --> N
L --> N
```

### 数据一致性维护

系统通过以下机制确保数据一致性：

| 一致性检查点 | 检查内容 | 处理方式 |
|-------------|----------|----------|
| 创建商品 | 产品编码唯一性 | 数据库约束 + 业务验证 |
| 更新库存 | 库存不能为负 | 业务逻辑 + 数据验证 |
| 同步价格 | 价格合理性 | 价格范围检查 |
| 删除商品 | 关联关系检查 | 级联删除 + 强制删除 |

### 性能瓶颈解决

针对常见的性能问题，系统提供了以下解决方案：

```mermaid
graph TD
A[性能问题] --> B{问题类型}
B --> |查询慢| C[优化SQL查询]
B --> |并发高| D[增加缓存]
B --> |内存占用高| E[优化数据结构]
B --> |网络延迟| F[异步处理]
C --> G[添加索引]
C --> H[减少JOIN]
D --> I[Redis缓存]
D --> J[CDN加速]
E --> K[压缩数据]
E --> L[懒加载]
F --> M[消息队列]
F --> N[批量处理]
```

**章节来源**
- [views.py](file://backend/catalog/views.py#L487-L493)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L147-L151)

## 总结

电动小程序的商品业务逻辑设计体现了现代电商平台的最佳实践，通过以下特点实现了高效、稳定、可扩展的商品管理：

### 核心优势

1. **统一的商品模型**: 支持本地商品和海尔商品的统一管理，简化了业务逻辑
2. **完善的API集成**: 深度集成海尔API，实现了商品数据的实时同步
3. **灵活的状态管理**: 通过多个状态字段精确控制商品的上下架和销售状态
4. **丰富的统计分析**: 提供了全面的商品表现统计和智能推荐功能
5. **严格的安全控制**: 多层次的权限控制确保数据安全和业务合规

### 技术特色

- **异步处理**: 海尔API同步采用异步处理，提高系统响应速度
- **缓存策略**: 多级缓存机制显著提升查询性能
- **错误恢复**: 完善的错误处理和恢复机制保证系统稳定性
- **监控告警**: 全面的日志记录和监控体系便于问题定位和性能优化

### 发展方向

未来可以考虑以下优化方向：
- 增强AI推荐算法，提供更精准的商品推荐
- 扩展多渠道商品管理，支持更多第三方平台
- 优化移动端体验，提供更好的用户体验
- 加强数据分析能力，为运营决策提供更多支持

这套商品业务逻辑为电动小程序提供了坚实的基础，支撑着整个电商业务的稳定运行和发展。