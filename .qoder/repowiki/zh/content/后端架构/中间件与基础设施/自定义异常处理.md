# 自定义异常处理

<cite>
**本文档引用的文件**
- [exceptions.py](file://backend/common/exceptions.py)
- [base.py](file://backend/backend/settings/base.py)
- [api.md](file://api.md)
</cite>

## 目录
1. [简介](#简介)
2. [业务异常设计](#业务异常设计)
3. [统一异常处理器](#统一异常处理器)
4. [未处理异常处理](#未处理异常处理)
5. [异常日志中间件](#异常日志中间件)
6. [错误响应格式](#错误响应格式)
7. [最佳实践](#最佳实践)

## 简介
本系统实现了完整的自定义异常处理机制，包括业务异常类、统一异常处理器、未处理异常处理器和异常日志中间件。该机制确保了API响应的一致性，提供了详细的错误信息用于开发调试，并在生产环境中保护了敏感信息。异常处理系统与Django REST Framework集成，能够处理各种业务场景下的错误情况。

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L1-L504)

## 业务异常设计
系统定义了`BusinessException`作为所有业务异常的基类，并在此基础上创建了多个具体的业务异常子类，每个异常都有明确的HTTP状态码、错误代码和使用场景。

### BusinessException基类
`BusinessException`是所有业务异常的基类，继承自DRF的`APIException`。它提供了统一的异常处理框架，包含错误代码、HTTP状态码和错误消息等属性。

```mermaid
classDiagram
class BusinessException {
+int status_code
+str default_detail
+str default_code
+str error_code
+__init__(detail, code, error_code)
}
BusinessException <|-- InsufficientStockError
BusinessException <|-- InvalidOrderStatusError
BusinessException <|-- PaymentVerificationError
BusinessException <|-- DuplicatePaymentError
BusinessException <|-- InvalidPaymentAmountError
BusinessException <|-- SupplierAPIError
BusinessException <|-- SupplierAuthenticationError
BusinessException <|-- ResourceConflictError
BusinessException <|-- InvalidFileError
BusinessException <|-- RateLimitExceededError
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L26-L57)

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L26-L57)

### 具体业务异常类
系统定义了多个具体的业务异常类，每个异常都针对特定的业务场景。

#### 库存相关异常
`InsufficientStockError`用于处理库存不足的情况，当用户尝试购买的数量超过可用库存时抛出此异常。

```mermaid
classDiagram
class InsufficientStockError {
+int status_code = 409
+str default_detail = "库存不足"
+str default_code = "insufficient_stock"
+str error_code = "INSUFFICIENT_STOCK"
}
InsufficientStockError --|> BusinessException
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L59-L75)

#### 订单状态异常
`InvalidOrderStatusError`用于处理无效的订单状态转换，当尝试对订单执行不合法的状态变更时抛出此异常。

```mermaid
classDiagram
class InvalidOrderStatusError {
+int status_code = 400
+str default_detail = "订单状态转换不合法"
+str default_code = "invalid_order_status"
+str error_code = "INVALID_ORDER_STATUS"
}
InvalidOrderStatusError --|> BusinessException
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L78-L94)

#### 支付相关异常
系统定义了多个支付相关的异常，用于处理各种支付场景下的错误。

```mermaid
classDiagram
class PaymentVerificationError {
+int status_code = 400
+str default_detail = "支付验证失败"
+str default_code = "payment_verification_failed"
+str error_code = "PAYMENT_VERIFICATION_FAILED"
}
class DuplicatePaymentError {
+int status_code = 409
+str default_detail = "重复支付"
+str default_code = "duplicate_payment"
+str error_code = "DUPLICATE_PAYMENT"
}
class InvalidPaymentAmountError {
+int status_code = 400
+str default_detail = "支付金额不匹配"
+str default_code = "invalid_payment_amount"
+str error_code = "INVALID_PAYMENT_AMOUNT"
}
PaymentVerificationError --|> BusinessException
DuplicatePaymentError --|> BusinessException
InvalidPaymentAmountError --|> BusinessException
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L97-L152)

#### 供应商集成异常
当与供应商API交互出现问题时，系统会抛出相应的异常。

```mermaid
classDiagram
class SupplierAPIError {
+int status_code = 502
+str default_detail = "供应商API调用失败"
+str default_code = "supplier_api_error"
+str error_code = "SUPPLIER_API_ERROR"
}
class SupplierAuthenticationError {
+int status_code = 401
+str default_detail = "供应商认证失败"
+str default_code = "supplier_auth_failed"
+str error_code = "SUPPLIER_AUTH_FAILED"
}
SupplierAPIError --|> BusinessException
SupplierAuthenticationError --|> BusinessException
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L154-L191)

## 统一异常处理器
`custom_exception_handler`是系统的统一异常处理器，负责格式化所有异常响应，确保API返回一致的错误格式。

### 处理流程
统一异常处理器的处理流程如下：

```mermaid
flowchart TD
Start([开始]) --> GetDRFResponse["获取DRF标准异常响应"]
GetDRFResponse --> CheckResponseValid{"响应有效?"}
CheckResponseValid --> |是| ExtractErrorInfo["提取错误信息"]
CheckResponseValid --> |否| HandleUnhandled["处理未处理异常"]
ExtractErrorInfo --> BuildResponse["构建格式化响应"]
BuildResponse --> CheckProduction{"生产环境?"}
CheckProduction --> |是| HideSensitive["隐藏敏感信息"]
CheckProduction --> |否| IncludeDetails["包含详细错误"]
HideSensitive --> SetGenericMessage["设置通用错误消息"]
IncludeDetails --> ReturnResponse
SetGenericMessage --> ReturnResponse
HandleUnhandled --> LogException["记录异常日志"]
LogException --> DetermineStatusCode["确定状态码"]
DetermineStatusCode --> BuildErrorResponse["构建错误响应"]
BuildErrorResponse --> ReturnResponse
ReturnResponse([返回响应])
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L251-L313)

### 错误信息提取
`_extract_error_info`函数负责从异常数据中提取关键信息，包括错误消息、详细错误和错误代码。

```mermaid
flowchart TD
Start([开始]) --> CheckExceptionType{"是否为BusinessException?"}
CheckExceptionType --> |是| GetErrorCode["获取error_code"]
CheckExceptionType --> |否| NoErrorCode["无error_code"]
GetErrorCode --> CheckErrorDataType{"错误数据类型?"}
NoErrorCode --> CheckErrorDataType
CheckErrorDataType --> |字典| CheckDetailKey{"包含'detail'键?"}
CheckDetailKey --> |是| UseDetailValue["使用detail值"]
CheckDetailKey --> |否| CheckMessageKey{"包含'message'键?"}
CheckMessageKey --> |是| UseMessageValue["使用message值"]
CheckMessageKey --> |否| MultipleFieldError["多字段错误"]
MultipleFieldError --> SetValidationMessage["设置验证错误消息"]
CheckErrorDataType --> |列表| UseFirstItem["使用第一项"]
CheckErrorDataType --> |其他| UseStringRepresentation["使用字符串表示"]
UseDetailValue --> End([结束])
UseMessageValue --> End
SetValidationMessage --> End
UseFirstItem --> End
UseStringRepresentation --> End
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L316-L350)

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L251-L350)

## 未处理异常处理
`_handle_unhandled_exception`函数负责处理DRF未捕获的异常，确保所有异常都能被妥善处理并返回安全的错误响应。

### 处理逻辑
未处理异常处理器的逻辑如下：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Handler as "_handle_unhandled_exception"
participant Logger as "日志系统"
participant Response as "响应"
Client->>Handler : 发生未处理异常
Handler->>Logger : 记录异常日志
Logger-->>Handler : 日志记录完成
Handler->>Handler : 确定状态码
alt DjangoValidationError
Handler->>Handler : 设置400状态码
else
Handler->>Handler : 设置500状态码
end
Handler->>Handler : 根据环境决定消息内容
alt 生产环境
Handler->>Handler : 使用通用错误消息
else
Handler->>Handler : 包含异常详细信息
end
Handler->>Response : 构建响应数据
Response-->>Client : 返回错误响应
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L353-L396)

### 环境感知错误响应
系统根据运行环境决定是否暴露详细的错误信息，保护生产环境的安全性。

```mermaid
flowchart TD
Start([异常发生]) --> CheckEnvironment{"生产环境?"}
CheckEnvironment --> |是| HideDetails["隐藏详细错误信息"]
CheckEnvironment --> |否| ShowDetails["显示详细错误信息"]
HideDetails --> UseGenericMessage["使用通用错误消息"]
ShowDetails --> IncludeExceptionInfo["包含异常信息"]
UseGenericMessage --> ReturnResponse
IncludeExceptionInfo --> ReturnResponse
ReturnResponse([返回响应])
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L384-L388)

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L353-L396)

## 异常日志中间件
`ExceptionLoggingMiddleware`是Django中间件，用于捕获视图层未处理的异常，记录日志并返回500错误响应，确保服务器不会因未捕获异常而崩溃。

### 中间件工作流程
异常日志中间件的工作流程如下：

```mermaid
flowchart TD
Start([请求进入]) --> ProcessRequest["处理请求"]
ProcessRequest --> HasException{"发生异常?"}
HasException --> |否| ReturnResponse["返回正常响应"]
HasException --> |是| LogException["记录异常日志"]
LogException --> BuildErrorResponse["构建错误响应"]
BuildErrorResponse --> CheckEnvironment{"生产环境?"}
CheckEnvironment --> |是| UseGenericError["使用通用错误消息"]
CheckEnvironment --> |否| IncludeDetails["包含详细信息"]
UseGenericError --> Return500Response
IncludeDetails --> Return500Response
Return500Response([返回500响应])
ReturnResponse --> End([结束])
Return500Response --> End
```

**Diagram sources**
- [exceptions.py](file://backend/common/exceptions.py#L442-L504)

### 配置与集成
异常日志中间件需要在Django设置中正确配置才能生效。

```mermaid
classDiagram
class ExceptionLoggingMiddleware {
-get_response
+__init__(get_response)
+__call__(request)
}
ExceptionLoggingMiddleware --> MIDDLEWARE : "添加到"
class MIDDLEWARE {
+list of middleware classes
}
MIDDLEWARE --> ExceptionLoggingMiddleware : "包含"
```

**Diagram sources**
- [base.py](file://backend/backend/settings/base.py#L162-L172)
- [exceptions.py](file://backend/common/exceptions.py#L442-L453)

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L442-L504)
- [base.py](file://backend/backend/settings/base.py#L162-L172)

## 错误响应格式
系统返回的错误响应具有统一的格式，便于前端处理和用户理解。

### 响应结构
错误响应的基本结构如下：

```mermaid
erDiagram
ERROR_RESPONSE {
boolean success PK
integer code
string message
string error_code
object errors
}
```

### 示例响应
不同类型的错误返回相应的响应格式。

```mermaid
flowchart TD
Start([错误类型]) --> BusinessError["业务错误"]
Start --> ValidationError["验证错误"]
Start --> ServerError["服务器错误"]
BusinessError --> ResponseFormat1["{
'success': false,
'code': 409,
'message': '库存不足',
'error_code': 'INSUFFICIENT_STOCK'
}"]
ValidationError --> ResponseFormat2["{
'success': false,
'code': 400,
'message': '验证错误',
'errors': {
'price': ['价格必须大于0'],
'stock': ['库存不能为负数']
}
}"]
ServerError --> ResponseFormat3["{
'success': false,
'code': 500,
'message': '服务器内部错误，请稍后重试'
}"]
```

**Diagram sources**
- [api.md](file://api.md#L736-L787)

**Section sources**
- [api.md](file://api.md#L736-L808)

## 最佳实践
系统在异常处理方面遵循了多项最佳实践，确保了代码的健壮性和可维护性。

### 异常使用指南
使用自定义异常的最佳实践包括：

```mermaid
flowchart TD
Start([何时抛出异常]) --> BusinessRuleViolation["业务规则违反"]
Start --> ExternalServiceFailure["外部服务失败"]
Start --> ValidationFailure["数据验证失败"]
BusinessRuleViolation --> UseBusinessException["使用BusinessException子类"]
ExternalServiceFailure --> UseSupplierAPIError["使用SupplierAPIError等"]
ValidationFailure --> UseInvalidError["使用InvalidXXXError"]
UseBusinessException --> ProvideDetail["提供详细错误信息"]
UseSupplierAPIError --> ProvideDetail
UseInvalidError --> ProvideDetail
ProvideDetail --> LogException["记录异常日志"]
LogException --> ReturnConsistentResponse["返回一致的响应格式"]
```

### 环境感知处理
系统根据运行环境调整错误处理策略：

```mermaid
flowchart TD
Start([异常发生]) --> CheckEnvironment{"环境类型?"}
CheckEnvironment --> |开发| ShowFullDetails["显示完整错误信息<br/>包含堆栈跟踪"]
CheckEnvironment --> |测试| ShowLimitedDetails["显示有限错误信息<br/>不包含敏感数据"]
CheckEnvironment --> |生产| ShowGenericMessage["显示通用错误消息<br/>隐藏技术细节"]
ShowFullDetails --> LogError["记录详细日志"]
ShowLimitedDetails --> LogError
ShowGenericMessage --> LogError
LogError --> ReturnResponse["返回响应"]
```

**Section sources**
- [exceptions.py](file://backend/common/exceptions.py#L251-L313)
- [api.md](file://api.md#L791-L805)