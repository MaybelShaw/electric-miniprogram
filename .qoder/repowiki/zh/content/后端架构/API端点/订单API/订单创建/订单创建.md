# 订单创建功能详细文档

<cite>
**本文档引用的文件**
- [backend/orders/views.py](file://backend/orders/views.py)
- [backend/orders/models.py](file://backend/orders/models.py)
- [backend/orders/serializers.py](file://backend/orders/serializers.py)
- [backend/orders/services.py](file://backend/orders/services.py)
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py)
- [backend/orders/urls.py](file://backend/orders/urls.py)
- [frontend/src/services/order.ts](file://frontend/src/services/order.ts)
- [frontend/src/pages/order-confirm/index.tsx](file://frontend/src/pages/order-confirm/index.tsx)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [订单创建流程](#订单创建流程)
5. [API接口详解](#api接口详解)
6. [事务处理机制](#事务处理机制)
7. [库存管理](#库存管理)
8. [错误处理与异常](#错误处理与异常)
9. [使用场景与最佳实践](#使用场景与最佳实践)
10. [故障排除指南](#故障排除指南)

## 概述

订单创建功能是电商系统的核心业务模块，负责处理用户下单、库存锁定、支付记录创建和订单快照生成等关键业务流程。系统提供了两种主要的订单创建方式：单个订单创建和批量订单创建，支持多种支付方式，并具备完善的事务处理机制确保数据一致性。

### 主要特性

- **双模式订单创建**：支持单商品订单和多商品批量订单
- **智能库存管理**：自动锁定库存，支持海尔产品特殊库存处理
- **支付集成**：支持多种支付方式，自动生成支付记录
- **状态机管理**：严格的订单状态流转控制
- **事务安全保障**：数据库事务确保操作原子性
- **错误处理机制**：完善的异常捕获和错误反馈

## 系统架构

```mermaid
graph TB
subgraph "前端层"
A[订单确认页面] --> B[订单服务]
B --> C[API请求]
end
subgraph "后端层"
C --> D[订单视图控制器]
D --> E[订单序列化器]
D --> F[订单服务]
F --> G[库存服务]
F --> H[支付服务]
F --> I[状态机]
end
subgraph "数据层"
J[订单模型] --> K[数据库]
L[支付模型] --> K
M[库存模型] --> K
N[地址模型] --> K
end
D --> J
D --> L
G --> M
E --> N
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L136-L305)
- [backend/orders/models.py](file://backend/orders/models.py#L13-L322)

## 核心组件分析

### 订单模型设计

订单模型包含了完整的订单信息，支持海尔产品的特殊需求：

```mermaid
classDiagram
class Order {
+string order_number
+User user
+Product product
+int quantity
+Decimal total_amount
+Decimal discount_amount
+Decimal actual_amount
+string status
+DateTime created_at
+DateTime updated_at
+string snapshot_contact_name
+string snapshot_phone
+string snapshot_address
+string haier_order_no
+string haier_so_id
+string haier_status
+DateTime distribution_time
+DateTime install_time
+bool is_delivery_install
+bool is_government_order
+string note
+prepare_haier_order_data() dict
+update_from_haier_callback() void
+update_logistics_info() void
}
class Payment {
+string method
+string status
+Decimal amount
+DateTime created_at
+DateTime expires_at
+JSON logs
+create_for_order() Payment
}
class OrderStatusHistory {
+Order order
+string from_status
+string to_status
+User operator
+DateTime created_at
+string note
}
Order --> Payment : "has_many"
Order --> OrderStatusHistory : "has_many"
```

**图表来源**
- [backend/orders/models.py](file://backend/orders/models.py#L13-L322)

### 订单状态机

订单状态机确保了订单状态流转的合法性：

```mermaid
stateDiagram-v2
[*] --> pending : 创建订单
pending --> paid : 支付成功
pending --> cancelled : 取消订单
paid --> shipped : 发货
paid --> refunded : 退款
paid --> cancelled : 支付后取消
shipped --> completed : 订单完成
shipped --> refunded : 申请退款
completed --> refunded : 售后退款
refunded --> paid : 退款取消
cancelled --> [*]
refunded --> [*]
```

**图表来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L33-L56)

**章节来源**
- [backend/orders/models.py](file://backend/orders/models.py#L13-L322)
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L14-L56)

## 订单创建流程

### 单个订单创建流程

```mermaid
sequenceDiagram
participant U as 用户
participant FC as 前端组件
participant VC as 视图控制器
participant S as 订单服务
participant IS as 库存服务
participant PM as 支付服务
participant DB as 数据库
U->>FC : 提交订单表单
FC->>VC : POST /orders/create_order/
VC->>VC : 验证请求参数
VC->>S : create_order()
S->>IS : 检查库存
IS->>DB : select_for_update()
DB-->>IS : 锁定商品行
IS->>IS : 扣减库存
S->>DB : 创建订单记录
S->>DB : 创建订单快照
S-->>VC : 返回订单对象
VC->>PM : 创建支付记录
PM->>DB : 存储支付信息
VC-->>FC : 返回订单和支付信息
FC-->>U : 显示订单确认
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L136-L217)
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)

### 批量订单创建流程

```mermaid
flowchart TD
A[接收批量订单请求] --> B[验证商品列表]
B --> C[合并相同商品]
C --> D[开始数据库事务]
D --> E[循环处理每个商品]
E --> F[调用create_order创建订单]
F --> G[创建支付记录]
G --> H{还有商品?}
H --> |是| E
H --> |否| I[提交事务]
I --> J[返回订单和支付列表]
F --> K[库存检查失败]
K --> L[回滚事务]
L --> M[返回错误信息]
G --> N[支付创建失败]
N --> L
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L219-L305)

**章节来源**
- [backend/orders/views.py](file://backend/orders/views.py#L136-L305)
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)

## API接口详解

### create_order API

#### 请求参数

| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| product_id | int | 是 | 商品ID | 123 |
| address_id | int | 是 | 收货地址ID | 456 |
| quantity | int | 否 | 商品数量，默认1 | 2 |
| note | string | 否 | 订单备注 | "请尽快发货" |
| method | string | 否 | 支付方式，默认wechat | "alipay" |
| user_id | int | 否 | 目标用户ID（管理员专用） | 789 |

#### 响应格式

```json
{
  "order": {
    "id": 1,
    "order_number": "1640995200123456",
    "user": 1,
    "product": {
      "id": 123,
      "name": "商品名称",
      "price": "199.99"
    },
    "quantity": 2,
    "total_amount": "399.98",
    "actual_amount": "359.98",
    "status": "pending",
    "created_at": "2023-01-01T10:00:00Z",
    "updated_at": "2023-01-01T10:00:00Z"
  },
  "payment": {
    "id": 1,
    "order": 1,
    "amount": "359.98",
    "method": "wechat",
    "status": "init",
    "created_at": "2023-01-01T10:00:00Z",
    "expires_at": "2023-01-01T10:30:00Z"
  }
}
```

#### 验证规则

- **商品验证**：商品必须存在且有效
- **地址验证**：地址必须属于当前用户
- **数量验证**：必须为正整数，默认为1
- **库存验证**：库存必须充足

### create_batch_orders API

#### 请求参数

| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| items | array | 是 | 商品列表 | [{"product_id": 123, "quantity": 2}] |
| address_id | int | 是 | 收货地址ID | 456 |
| note | string | 否 | 订单备注 | "请尽快发货" |
| method | string | 否 | 支付方式，默认wechat | "alipay" |

#### 商品列表结构

```json
{
  "items": [
    {
      "product_id": 123,
      "quantity": 2
    },
    {
      "product_id": 456,
      "quantity": 1
    }
  ],
  "address_id": 789,
  "note": "备注信息"
}
```

#### 响应格式

```json
{
  "orders": [
    {
      "id": 1,
      "order_number": "1640995200123456",
      "product": {
        "id": 123,
        "name": "商品A"
      },
      "quantity": 2,
      "total_amount": "399.98"
    }
  ],
  "payments": [
    {
      "id": 1,
      "order": 1,
      "amount": "399.98",
      "method": "wechat",
      "status": "init"
    }
  ]
}
```

**章节来源**
- [backend/orders/views.py](file://backend/orders/views.py#L136-L305)
- [backend/orders/serializers.py](file://backend/orders/serializers.py#L99-L138)

## 事务处理机制

### 数据一致性保障

系统采用数据库事务确保订单创建过程的数据一致性：

```mermaid
sequenceDiagram
participant TC as 事务控制器
participant IS as 库存服务
participant OS as 订单服务
participant PS as 支付服务
participant DB as 数据库
TC->>DB : BEGIN TRANSACTION
DB-->>TC : 事务开始
TC->>OS : create_order()
OS->>IS : lock_stock()
IS->>DB : SELECT FOR UPDATE
DB-->>IS : 锁定商品行
IS->>IS : 检查库存
IS->>IS : 扣减库存
IS-->>OS : 库存锁定成功
OS->>DB : INSERT INTO orders
OS-->>TC : 订单创建成功
TC->>PS : create_for_order()
PS->>DB : INSERT INTO payments
PS-->>TC : 支付记录创建成功
TC->>DB : COMMIT
DB-->>TC : 事务提交成功
Note over TC,DB : 所有操作成功，数据一致
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L264-L297)

### 并发控制机制

系统使用数据库行锁防止并发订单导致的库存超卖：

```mermaid
flowchart TD
A[用户A请求] --> B[获取商品行锁]
B --> C[检查库存]
C --> D{库存充足?}
D --> |是| E[扣减库存]
D --> |否| F[抛出异常]
E --> G[创建订单]
G --> H[提交事务]
I[用户B请求] --> J[等待锁释放]
J --> K[重新获取锁]
K --> L[检查库存]
L --> M{库存充足?}
M --> |是| N[扣减库存]
M --> |否| O[抛出异常]
N --> P[创建订单]
P --> Q[提交事务]
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L333-L371)

**章节来源**
- [backend/orders/services.py](file://backend/orders/services.py#L264-L297)
- [backend/orders/services.py](file://backend/orders/services.py#L333-L371)

## 库存管理

### 库存锁定策略

系统实现了智能库存管理，支持不同类型的库存处理：

```mermaid
flowchart TD
A[订单创建请求] --> B{是否为海尔产品?}
B --> |是| C[调用海尔库存API]
B --> |否| D[锁定本地库存]
C --> E{库存是否充足?}
E --> |是| F[继续订单流程]
E --> |否| G[抛出库存不足异常]
D --> H[获取商品行锁]
H --> I{库存是否充足?}
I --> |是| J[扣减库存]
I --> |否| K[抛出库存不足异常]
J --> L[创建订单]
F --> L
G --> M[回滚事务]
K --> M
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)
- [backend/orders/services.py](file://backend/orders/services.py#L123-L217)

### 库存释放机制

订单取消或退款时自动释放锁定的库存：

```mermaid
sequenceDiagram
participant U as 用户/系统
participant SM as 状态机
participant IS as 库存服务
participant DB as 数据库
U->>SM : 取消订单
SM->>SM : 检查状态转换
SM->>IS : release_stock()
IS->>DB : SELECT FOR UPDATE
DB-->>IS : 锁定商品行
IS->>IS : 增加库存
IS->>DB : UPDATE stock
IS->>DB : INSERT INTO inventory_logs
IS-->>SM : 库存释放成功
SM->>DB : 更新订单状态
SM-->>U : 订单取消完成
```

**图表来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L212-L232)

**章节来源**
- [backend/orders/services.py](file://backend/orders/services.py#L123-L217)
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L212-L232)

## 错误处理与异常

### 常见错误类型

| 错误类型 | HTTP状态码 | 错误信息 | 解决方案 |
|----------|------------|----------|----------|
| 商品不存在 | 400 | "商品不存在" | 检查商品ID有效性 |
| 地址无效 | 400 | "地址无效或不属于当前用户" | 验证地址ID和用户关系 |
| 库存不足 | 400 | "库存不足" | 检查库存状态或等待补货 |
| 数量无效 | 400 | "数量必须为正整数" | 提供有效的数量值 |
| 系统异常 | 500 | "创建订单失败" | 检查系统日志，联系技术支持 |

### 异常处理流程

```mermaid
flowchart TD
A[订单创建请求] --> B[参数验证]
B --> C{验证通过?}
C --> |否| D[返回400错误]
C --> |是| E[业务逻辑处理]
E --> F{业务逻辑正确?}
F --> |否| G[返回400错误]
F --> |是| H[数据库操作]
H --> I{数据库操作成功?}
I --> |否| J[回滚事务]
J --> K[返回500错误]
I --> |是| L[提交事务]
L --> M[返回成功响应]
D --> N[记录错误日志]
G --> N
K --> N
N --> O[返回给客户端]
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L198-L208)

### 海尔产品特殊处理

对于海尔产品，系统提供了特殊的库存检查和错误处理：

```mermaid
flowchart TD
A[海尔产品订单] --> B[获取区域编码]
B --> C{使用模拟数据?}
C --> |是| D[使用模拟库存API]
C --> |否| E[调用真实海尔API]
D --> F{库存充足?}
E --> F
F --> |是| G[继续订单流程]
F --> |否| H[抛出库存不足异常]
G --> I[记录库存信息]
H --> J[记录错误日志]
I --> K[订单创建成功]
J --> L[返回错误响应]
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L123-L217)

**章节来源**
- [backend/orders/views.py](file://backend/orders/views.py#L198-L208)
- [backend/orders/services.py](file://backend/orders/services.py#L123-L217)

## 使用场景与最佳实践

### 单商品订单创建场景

适用于用户直接从商品详情页下单的场景：

1. **用户选择商品**：用户在商品详情页选择规格和数量
2. **填写收货信息**：用户选择或填写收货地址
3. **确认订单**：用户确认订单信息并提交
4. **支付处理**：系统创建订单并生成支付记录
5. **订单跟踪**：用户可在订单列表中查看订单状态

### 批量订单创建场景

适用于购物车结算的场景：

1. **购物车管理**：用户添加多个商品到购物车
2. **批量结算**：用户一次性结算购物车中的所有商品
3. **去重处理**：系统自动合并相同商品的不同规格
4. **统一支付**：为每个订单创建独立的支付记录
5. **库存分配**：系统分别锁定每个订单的库存

### 性能优化建议

1. **缓存策略**：缓存用户地址和商品信息减少数据库查询
2. **批量操作**：使用批量API减少网络请求次数
3. **异步处理**：订单创建完成后可异步处理后续任务
4. **索引优化**：确保订单、支付、库存相关字段有适当索引

### 安全考虑

1. **权限验证**：确保用户只能访问自己的订单和地址
2. **参数校验**：严格验证所有输入参数的有效性
3. **防重复提交**：使用令牌机制防止重复下单
4. **敏感信息保护**：加密存储支付相关信息

**章节来源**
- [frontend/src/pages/order-confirm/index.tsx](file://frontend/src/pages/order-confirm/index.tsx#L1-L240)
- [frontend/src/services/order.ts](file://frontend/src/services/order.ts#L1-L47)

## 故障排除指南

### 常见问题诊断

#### 订单创建失败

**症状**：用户提交订单后收到"创建订单失败"的错误

**排查步骤**：
1. 检查商品是否存在且有效
2. 验证用户地址是否正确
3. 确认库存是否充足
4. 查看系统日志获取详细错误信息

**解决方案**：
- 更新商品信息或下架无效商品
- 清理无效地址或提示用户重新选择
- 联系供应商补货或调整库存

#### 库存超卖问题

**症状**：多个用户同时购买同一件商品导致库存显示为负数

**排查步骤**：
1. 检查数据库行锁是否正常工作
2. 验证事务隔离级别设置
3. 查看并发请求的日志

**解决方案**：
- 确保使用SELECT FOR UPDATE锁定商品行
- 设置适当的数据库事务隔离级别
- 实现分布式锁防止极端并发情况

#### 支付记录丢失

**症状**：订单创建成功但支付记录未生成

**排查步骤**：
1. 检查支付服务是否正常运行
2. 验证数据库连接状态
3. 查看支付记录创建的日志

**解决方案**：
- 重启支付服务或修复相关依赖
- 检查数据库配置和连接池设置
- 手动创建缺失的支付记录

### 监控和告警

建议监控以下关键指标：

1. **订单创建成功率**：监控订单创建的成功率
2. **库存检查耗时**：监控库存检查的响应时间
3. **支付处理延迟**：监控支付记录创建的时间
4. **异常发生频率**：监控各种错误的发生频率

### 性能调优

1. **数据库优化**：为订单、支付、库存相关表添加索引
2. **缓存策略**：缓存热门商品和用户地址信息
3. **连接池配置**：优化数据库连接池大小
4. **异步处理**：将非关键操作异步化处理

**章节来源**
- [backend/orders/views.py](file://backend/orders/views.py#L198-L208)
- [backend/orders/services.py](file://backend/orders/services.py#L333-L371)