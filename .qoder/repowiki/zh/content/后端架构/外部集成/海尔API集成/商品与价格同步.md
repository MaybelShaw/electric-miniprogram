# 商品与价格同步

<cite>
**本文档中引用的文件**
- [haierapi.py](file://backend/integrations/haierapi.py)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py)
- [models.py](file://backend/catalog/models.py)
- [integrations/models.py](file://backend/integrations/models.py)
- [admin.py](file://backend/integrations/admin.py)
- [env_config.py](file://backend/backend/settings/env_config.py)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构](#系统架构)
3. [海尔API接口详解](#海尔api接口详解)
4. [商品同步管理命令](#商品同步管理命令)
5. [商品模型映射](#商品模型映射)
6. [同步日志系统](#同步日志系统)
7. [同步流程分析](#同步流程分析)
8. [配置管理](#配置管理)
9. [性能优化](#性能优化)
10. [故障排查指南](#故障排查指南)

## 概述

商品与价格同步系统是一个完整的供应链集成解决方案，负责从海尔API获取商品数据并同步到本地数据库。该系统支持多种同步策略，包括按商品编码、分类和品牌进行过滤，同时提供价格信息合并和库存同步功能。

### 核心特性

- **多维度过滤**：支持按product-codes、category、brand进行灵活筛选
- **价格同步**：通过--sync-prices选项触发价格信息合并
- **库存同步**：支持实时库存查询和更新
- **审计追踪**：完整的同步日志记录系统
- **错误处理**：完善的异常处理和重试机制

## 系统架构

```mermaid
graph TB
subgraph "前端管理界面"
Admin[管理员界面]
CLI[命令行工具]
end
subgraph "后端服务层"
CMD[sync_haier_products命令]
API[HaierAPI客户端]
MODEL[Product模型]
end
subgraph "数据层"
DB[(本地数据库)]
LOG[(同步日志)]
end
subgraph "外部API"
HAIER[海尔API服务器]
end
Admin --> CMD
CLI --> CMD
CMD --> API
CMD --> MODEL
MODEL --> DB
MODEL --> LOG
API --> HAIER
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L13-L156)
- [haierapi.py](file://backend/integrations/haierapi.py#L10-L214)
- [models.py](file://backend/catalog/models.py#L43-L312)

## 海尔API接口详解

### HaierAPI类设计

HaierAPI类是与海尔开放平台交互的核心组件，提供了完整的API调用封装。

```mermaid
classDiagram
class HaierAPI {
+string client_id
+string client_secret
+string token_url
+string base_url
+string customer_code
+string send_to_code
+string supplier_code
+string password
+string seller_password
+string access_token
+string token_type
+datetime token_expiry
+authenticate() bool
+get_products(product_codes) Dict[]
+get_product_prices(product_codes) Dict[]
+check_stock(product_code, county_code) Dict
+get_logistics_info(order_code) Dict
+get_account_balance() Dict
+from_settings() HaierAPI
-_ensure_authenticated() bool
-_auth_headers() Dict
}
class HaierConfig {
+string name
+JSONField config
+bool is_active
+datetime created_at
+datetime updated_at
}
HaierAPI --> HaierConfig : "使用配置"
```

**图表来源**
- [haierapi.py](file://backend/integrations/haierapi.py#L10-L214)
- [integrations/models.py](file://backend/integrations/models.py#L4-L47)

### get_products()接口

`get_products()`方法用于获取海尔商品信息，支持多种过滤条件：

#### 请求参数

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| customerCode | string | 是 | 客户编码，从配置中读取 |
| supplierCode | string | 是 | 供应商编码，默认'1001' |
| searchType | string | 是 | 搜索类型，固定为'PTJSH' |
| passWord | string | 是 | 密码验证 |
| sendToCode | string | 否 | 发送目标编码 |
| productCodes | array | 否 | 商品编码列表，最多20个 |

#### 响应数据结构

```mermaid
flowchart TD
A[API响应] --> B{响应格式检查}
B --> |List| C[直接返回]
B --> |Dict| D[提取data字段]
B --> |其他| E[返回空]
C --> F[商品数据列表]
D --> G{data存在?}
G --> |是| F
G --> |否| E
```

**图表来源**
- [haierapi.py](file://backend/integrations/haierapi.py#L74-L97)

### get_product_prices()接口

`get_product_prices()`方法专门用于获取商品价格信息：

#### 请求参数

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| customerCode | string | 是 | 客户编码 |
| sendToCode | string | 否 | 发送目标编码 |
| productCodes | array | 是 | 商品编码列表，最多20个 |
| priceType | string | 是 | 价格类型，固定为'PT' |
| passWord | string | 是 | 密码验证 |

#### 价格字段映射

| 海尔字段 | 本地字段 | 描述 |
|----------|----------|------|
| supplyPrice | supply_price | 普通供价 |
| invoicePrice | invoice_price | 开票价 |
| marketPrice | market_price | 市场价 |
| stockRebatePolicy | stock_rebate | 直扣政策 |
| rebateMoney | rebate_money | 台返金额 |

**章节来源**
- [haierapi.py](file://backend/integrations/haierapi.py#L74-L119)

## 商品同步管理命令

### 命令行接口设计

sync_haier_products命令提供了丰富的同步控制选项：

```mermaid
flowchart TD
A[命令启动] --> B[加载配置]
B --> C[API认证]
C --> D{认证成功?}
D --> |否| E[退出]
D --> |是| F[解析过滤参数]
F --> G[获取商品数据]
G --> H{有商品数据?}
H --> |否| I[提示无数据]
H --> |是| J[遍历商品]
J --> K{需要同步价格?}
K --> |是| L[获取价格信息]
K --> |否| M[同步商品]
L --> N[合并价格数据]
N --> M
M --> O[同步库存?]
O --> |是| P[查询库存]
O --> |否| Q[计数+1]
P --> R{库存查询成功?}
R --> |是| S[更新库存]
R --> |否| T[记录警告]
S --> Q
T --> Q
Q --> U{还有商品?}
U --> |是| J
U --> |否| V[输出统计结果]
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L50-L156)

### 过滤策略

#### 1. 按商品编码过滤
```bash
python manage.py sync_haier_products --product-codes GA0SZC00U GA0SZC00V
```

#### 2. 按分类过滤
```bash
python manage.py sync_haier_products --category "空调"
```

#### 3. 按品牌过滤
```bash
python manage.py sync_haier_products --brand "海尔"
```

#### 4. 组合过滤
```bash
python manage.py sync_haier_products --category "冰箱" --brand "美的" --sync-prices
```

### 选项参数详解

| 参数 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| --product-codes | List[str] | None | 指定要同步的产品编码列表 |
| --category | str | None | 指定商品分类名称 |
| --brand | str | None | 指定品牌名称 |
| --sync-prices | bool | False | 同步价格信息 |
| --sync-stock | bool | False | 同步库存信息 |
| --county-code | str | "110101" | 区域编码（用于库存查询） |

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L16-L48)

## 商品模型映射

### Product.sync_from_haier()静态方法

该方法是商品数据同步的核心，负责将海尔API返回的原始数据映射到本地Product模型：

```mermaid
sequenceDiagram
participant CMD as 同步命令
participant API as HaierAPI
participant MODEL as Product模型
participant DB as 数据库
CMD->>API : get_products()
API-->>CMD : 商品数据
CMD->>MODEL : sync_from_haier(data, category, brand)
MODEL->>DB : get_or_create(product_code)
DB-->>MODEL : 商品对象
MODEL->>MODEL : 更新基础信息
MODEL->>MODEL : 更新价格信息
MODEL->>MODEL : 处理品牌关联
MODEL->>DB : save()
DB-->>MODEL : 保存完成
MODEL-->>CMD : 返回商品对象
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L116-L118)
- [models.py](file://backend/catalog/models.py#L118-L179)

### 数据映射规则

#### 基础字段映射

| 海尔字段 | 本地字段 | 处理方式 |
|----------|----------|----------|
| productCode | product_code | 主键，唯一标识 |
| productModel | name | 商品名称，使用model作为默认值 |
| productImageUrl | product_image_url | 主图URL |
| productLageUrls | product_page_urls | 拉页URL列表 |
| isSales | is_sales | 销售状态，'1'表示可采 |
| noSalesReason | no_sales_reason | 不可采原因 |

#### 价格信息映射

```mermaid
flowchart TD
A[海尔价格数据] --> B{supplyPrice存在?}
B --> |是| C[设置supply_price]
B --> |否| D[保持原值]
C --> E[设置price=supply_price]
E --> F{invoicePrice存在?}
F --> |是| G[设置invoice_price]
F --> |否| H[保持原值]
G --> I{stockRebatePolicy存在?}
I --> |是| J[设置stock_rebate]
I --> |否| K[保持原值]
J --> L{rebateMoney存在?}
L --> |是| M[设置rebate_money]
L --> |否| N[保持原值]
M --> O[保存商品]
N --> O
D --> F
H --> I
K --> L
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L157-L167)

### update_stock_from_haier()方法

该方法专门处理库存信息的更新：

#### 库存字段映射

| 海尔字段 | 本地字段 | 描述 |
|----------|----------|------|
| stock | stock | 库存数量 |
| secCode | warehouse_code | 库位编码 |
| warehouseGrade | warehouse_grade | 仓库等级 |

**章节来源**
- [models.py](file://backend/catalog/models.py#L118-L194)

## 同步日志系统

### HaierSyncLog模型设计

HaierSyncLog模型提供了完整的同步操作审计功能：

```mermaid
classDiagram
class HaierSyncLog {
+CharField sync_type
+CharField status
+TextField message
+IntegerField total_count
+IntegerField success_count
+IntegerField failed_count
+DateTimeField started_at
+DateTimeField completed_at
+DateTimeField created_at
+duration() float
}
class SyncTypeChoices {
<<enumeration>>
products
prices
stock
order
logistics
manual
}
class StatusChoices {
<<enumeration>>
pending
processing
success
failed
partial
}
HaierSyncLog --> SyncTypeChoices
HaierSyncLog --> StatusChoices
```

**图表来源**
- [integrations/models.py](file://backend/integrations/models.py#L50-L149)

### 日志记录策略

#### 同步类型分类

| 同步类型 | 描述 | 触发时机 |
|----------|------|----------|
| products | 商品同步 | 批量获取商品信息 |
| prices | 价格同步 | 单个商品价格查询 |
| stock | 库存同步 | 库存状态更新 |
| order | 订单推送 | 订单状态变更 |
| logistics | 物流查询 | 物流信息获取 |
| manual | 手动操作 | 用户手动触发 |

#### 状态流转

```mermaid
stateDiagram-v2
[*] --> pending : 创建日志
pending --> processing : 开始处理
processing --> success : 全部成功
processing --> failed : 全部失败
processing --> partial : 部分成功
success --> [*]
failed --> [*]
partial --> [*]
```

### 审计功能

#### 关键指标监控

- **处理效率**：通过duration属性计算同步耗时
- **成功率**：success_count / total_count
- **错误追踪**：详细的message字段记录
- **时间线**：按created_at排序的完整操作历史

**章节来源**
- [integrations/models.py](file://backend/integrations/models.py#L50-L149)
- [admin.py](file://backend/integrations/admin.py#L14-L26)

## 同步流程分析

### 完整同步流程

```mermaid
flowchart TD
A[开始同步] --> B[加载配置]
B --> C[初始化API客户端]
C --> D[执行OAuth认证]
D --> E{认证成功?}
E --> |否| F[记录失败日志]
E --> |是| G[加载过滤条件]
G --> H[调用get_products]
H --> I{获取到数据?}
I --> |否| J[记录无数据]
I --> |是| K[遍历商品数据]
K --> L{需要同步价格?}
L --> |是| M[调用get_product_prices]
L --> |否| N[同步商品基础信息]
M --> O[合并价格数据]
O --> N
N --> P[调用sync_from_haier]
P --> Q{同步成功?}
Q --> |是| R[记录成功日志]
Q --> |否| S[记录失败日志]
R --> T{需要同步库存?}
S --> T
T --> |是| U[调用check_stock]
T --> |否| V[计数+1]
U --> W{库存查询成功?}
W --> |是| X[调用update_stock_from_haier]
W --> |否| Y[记录库存失败]
X --> Z[记录库存成功]
Y --> V
Z --> V
V --> AA{还有商品?}
AA --> |是| K
AA --> |否| BB[生成统计报告]
BB --> CC[更新同步日志]
CC --> DD[结束]
F --> DD
J --> DD
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L50-L156)

### 错误处理机制

#### 分层错误处理

1. **网络层错误**：API调用失败，记录HTTP状态码和错误信息
2. **认证层错误**：Token过期或无效，自动重新认证
3. **业务层错误**：商品数据格式错误，跳过当前商品继续处理
4. **数据库层错误**：保存失败，记录详细错误信息

#### 重试策略

- **指数退避**：网络错误时采用指数退避算法
- **最大重试次数**：限制重试次数防止无限循环
- **熔断机制**：连续失败超过阈值时暂停同步

### 性能优化

#### 批量处理优化

- **产品编码限制**：每次API调用最多20个商品编码
- **并发控制**：合理控制并发请求数量
- **缓存机制**：对频繁访问的配置信息进行缓存

#### 数据库优化

- **索引策略**：为product_code、supplier、supplier_code建立复合索引
- **批量更新**：使用Django的bulk_update功能提高效率
- **事务管理**：确保数据一致性

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L147-L156)

## 配置管理

### 环境配置

系统支持多环境配置管理，通过EnvironmentConfig类实现：

```mermaid
classDiagram
class EnvironmentConfig {
+get_env(key, default) str
+is_production() bool
+is_development() bool
+get_secret_key() str
+get_allowed_hosts() list
+get_debug() bool
+get_database_config() dict
+validate_production_config() void
}
class HaierConfig {
+string name
+JSONField config
+bool is_active
+validate_config() bool
}
EnvironmentConfig --> HaierConfig : "管理配置"
```

**图表来源**
- [env_config.py](file://backend/backend/settings/env_config.py#L37-L252)
- [integrations/models.py](file://backend/integrations/models.py#L4-L47)

### 配置参数详解

#### 海尔API配置参数

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| client_id | string | 是 | OAuth客户端ID |
| client_secret | string | 是 | OAuth客户端密钥 |
| token_url | string | 是 | Token获取地址 |
| base_url | string | 是 | API基础URL |
| customer_code | string | 是 | 客户编码 |
| send_to_code | string | 否 | 发送目标编码 |
| supplier_code | string | 否 | 供应商编码，默认'1001' |
| password | string | 是 | API访问密码 |
| seller_password | string | 是 | 卖家密码 |

#### 环境变量配置

```bash
# 基础配置
DJANGO_ENV=development
SECRET_KEY=your-secret-key
ALLOWED_HOSTS=localhost,127.0.0.1

# 数据库配置
POSTGRES_DB=electric_miniprogram
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

# 海尔API配置
HAIER_CLIENT_ID=your-client-id
HAIER_CLIENT_SECRET=your-client-secret
HAIER_TOKEN_URL=https://openplat-test.haier.net/oauth2/auth
HAIER_BASE_URL=https://openplat-test.haier.net
HAIER_CUSTOMER_CODE=8800633175
HAIER_SEND_TO_CODE=8800633175
HAIER_SUPPLIER_CODE=1001
HAIER_PASSWORD=your-password
HAIER_SELLER_PASSWORD=your-password
```

**章节来源**
- [env_config.py](file://backend/backend/settings/env_config.py#L14-L32)
- [haierapi.py](file://backend/integrations/haierapi.py#L27-L39)

## 性能优化

### 并发处理优化

#### 异步处理策略

虽然当前实现是同步的，但系统设计支持未来的异步扩展：

```mermaid
sequenceDiagram
participant CMD as 命令处理器
participant QUEUE as 消息队列
participant WORKER as 工作进程
participant API as 海尔API
CMD->>QUEUE : 提交同步任务
QUEUE->>WORKER : 分发任务
WORKER->>API : 并发API调用
API-->>WORKER : 并发响应
WORKER->>WORKER : 数据处理
WORKER->>QUEUE : 更新进度
QUEUE-->>CMD : 通知完成
```

#### 缓存策略

- **配置缓存**：缓存HaierConfig配置避免重复查询
- **认证缓存**：Token有效期管理，减少认证频率
- **数据缓存**：热点商品数据缓存

### 监控指标

#### 关键性能指标(KPI)

| 指标 | 计算公式 | 目标值 |
|------|----------|--------|
| 同步速度 | 总商品数 / 同步耗时 | >100商品/分钟 |
| 成功率 | 成功数 / 总数 | >95% |
| 平均响应时间 | 总响应时间 / 请求次数 | <5秒 |
| 错误率 | 失败数 / 总数 | <5% |

#### 监控告警

- **同步延迟**：超过预设时间阈值发送告警
- **失败率过高**：连续失败超过阈值触发告警
- **API限流**：遇到限流错误及时告警

## 故障排查指南

### 常见问题及解决方案

#### 1. 认证失败

**症状**：命令执行时显示"认证失败"

**可能原因**：
- OAuth配置错误
- 网络连接问题
- Token过期

**解决步骤**：
```bash
# 检查配置
python manage.py shell
>>> from integrations.haierapi import HaierAPI
>>> from django.conf import settings
>>> config = {...}  # 使用实际配置
>>> api = HaierAPI(config)
>>> api.authenticate()

# 检查网络连通性
curl -X POST https://openplat-test.haier.net/oauth2/auth \
  -H "Content-Type: application/json" \
  -d '{"client_id":"your_id","client_secret":"your_secret","grant_type":"client_credentials"}'
```

#### 2. 商品数据为空

**症状**：显示"未查询到商品"

**可能原因**：
- 过滤条件过于严格
- API权限不足
- 商品编码不存在

**排查步骤**：
```bash
# 尝试不带过滤条件
python manage.py sync_haier_products

# 检查具体商品
python manage.py sync_haier_products --product-codes GA0SZC00U
```

#### 3. 价格同步失败

**症状**：价格信息未更新

**可能原因**：
- 价格API权限不足
- 商品编码不在价格查询范围内
- 网络超时

**调试方法**：
```python
# 在shell中测试
from integrations.haierapi import HaierAPI
api = HaierAPI.from_settings()
prices = api.get_product_prices(['GA0SZC00U'])
print(prices)  # 检查返回数据
```

#### 4. 库存同步问题

**症状**：库存信息不准确

**排查重点**：
- county_code是否正确
- 库存API权限
- 地区编码有效性

### 日志分析

#### 查看同步日志

```bash
# 通过管理界面查看
# 或者通过shell查询
python manage.py shell
>>> from integrations.models import HaierSyncLog
>>> logs = HaierSyncLog.objects.all().order_by('-created_at')
>>> for log in logs[:10]:
...     print(f"{log.created_at}: {log.sync_type} - {log.status}")
```

#### 日志解读要点

- **sync_type**: 确认同步类型是否符合预期
- **status**: 检查是否有failed状态
- **message**: 查看具体的错误信息
- **duration**: 监控同步性能

### 性能调优建议

#### 大规模同步优化

1. **分批处理**：对于大量商品，建议分批次同步
2. **并发控制**：根据API限流情况调整并发数
3. **错误恢复**：实现断点续传功能
4. **资源监控**：监控CPU和内存使用情况

#### 生产环境部署

```bash
# 使用后台进程运行
nohup python manage.py sync_haier_products --sync-prices --sync-stock > sync.log 2>&1 &

# 设置定时任务
crontab -e
# 每天凌晨2点同步
0 2 * * * cd /path/to/project && python manage.py sync_haier_products --sync-prices >> /var/log/sync.log 2>&1
```

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L67-L70)
- [haierapi.py](file://backend/integrations/haierapi.py#L41-L64)

## 结论

商品与价格同步系统是一个功能完整、设计合理的供应链集成解决方案。它通过模块化的架构设计，提供了灵活的同步策略、完善的错误处理机制和全面的审计功能。系统支持多种过滤条件，能够满足不同场景下的商品同步需求，同时通过同步日志系统确保了操作的可追溯性和系统的稳定性。

该系统的设计充分考虑了生产环境的复杂性，提供了丰富的配置选项和监控指标，为后续的功能扩展和性能优化奠定了良好的基础。通过合理的错误处理和重试机制，系统能够在各种网络环境下稳定运行，确保商品数据的及时性和准确性。