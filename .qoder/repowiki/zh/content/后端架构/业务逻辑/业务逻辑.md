# 业务逻辑

<cite>
**本文档引用的文件**
- [backend/orders/models.py](file://backend/orders/models.py)
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py)
- [backend/orders/payment_service.py](file://backend/orders/payment_service.py)
- [backend/orders/services.py](file://backend/orders/services.py)
- [backend/orders/views.py](file://backend/orders/views.py)
- [backend/catalog/search.py](file://backend/catalog/search.py)
- [backend/users/services.py](file://backend/users/services.py)
- [backend/common/exceptions.py](file://backend/common/exceptions.py)
</cite>

## 目录
1. [概述](#概述)
2. [订单创建流程](#订单创建流程)
3. [订单状态机](#订单状态机)
4. [支付生命周期管理](#支付生命周期管理)
5. [商品搜索算法](#商品搜索算法)
6. [用户认证与资料更新](#用户认证与资料更新)
7. [API视图调用关系](#api视图调用关系)
8. [异常处理机制](#异常处理机制)
9. [总结](#总结)

## 概述

本文档深入分析了电商小程序项目的核心业务逻辑实现，重点关注orders应用中的订单创建流程、状态转换规则、支付生命周期管理，以及catalog/search.py中的商品搜索算法和排序逻辑。同时阐述了users/services.py中的用户认证和资料更新逻辑，结合views.py中的调用关系，说明服务层如何被API视图调用，以及异常处理机制的应用。

## 订单创建流程

### 核心业务逻辑架构

订单创建流程是整个电商系统的核心，涉及库存检查、快照生成、支付记录创建等多个环节的原子性操作。

```mermaid
flowchart TD
A["用户发起订单创建"] --> B["验证请求参数"]
B --> C["检查商品库存"]
C --> D{"库存检查"}
D --> |不足| E["抛出InsufficientStockError"]
D --> |充足| F["锁定库存"]
F --> G["生成订单快照"]
G --> H["创建支付记录"]
H --> I["事务提交"]
I --> J["返回订单信息"]
K["海尔产品"] --> L["调用海尔库存API"]
L --> M{"库存充足?"}
M --> |是| N["跳过本地库存锁定"]
M --> |否| O["抛出库存不足异常"]
P["普通产品"] --> Q["调用InventoryService.lock_stock"]
Q --> R["数据库行锁锁定"]
R --> S["更新库存数量"]
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)
- [backend/orders/views.py](file://backend/orders/views.py#L136-L217)

### 库存检查机制

库存检查分为两种场景：普通产品和海尔产品。

#### 普通产品库存检查
对于非海尔产品，系统使用数据库行锁确保库存的并发安全性：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant View as "OrderViewSet"
participant Service as "InventoryService"
participant DB as "数据库"
Client->>View : POST /api/orders/create_order
View->>Service : lock_stock(product_id, quantity)
Service->>DB : SELECT FOR UPDATE
DB-->>Service : 锁定商品行
Service->>Service : 检查库存是否足够
alt 库存充足
Service->>DB : UPDATE stock = stock - quantity
Service->>DB : INSERT INTO inventory_log
Service-->>View : 返回True
else 库存不足
Service->>DB : ROLLBACK
Service-->>View : 抛出ValueError
end
View-->>Client : 返回订单或错误
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L332-L372)

#### 海尔产品库存检查
海尔产品使用外部API进行库存验证：

```mermaid
flowchart TD
A["检查产品来源"] --> B{"是否为海尔产品?"}
B --> |是| C["调用check_haier_stock"]
B --> |否| D["使用本地库存检查"]
C --> E["获取区域编码"]
E --> F{"使用模拟数据?"}
F --> |是| G["返回模拟库存信息"]
F --> |否| H["调用HaierAPI.check_stock"]
H --> I["验证API响应"]
I --> J{"库存充足?"}
J --> |是| K["返回库存信息"]
J --> |否| L["抛出ValueError"]
G --> M["继续订单创建"]
K --> M
D --> M
```

**图表来源**
- [backend/orders/services.py](file://backend/orders/services.py#L123-L216)

**章节来源**
- [backend/orders/services.py](file://backend/orders/services.py#L219-L297)
- [backend/orders/views.py](file://backend/orders/views.py#L136-L217)

### 快照生成机制

订单创建时会生成商品快照，确保订单状态的不可变性：

| 快照字段 | 描述 | 数据来源 |
|---------|------|----------|
| snapshot_contact_name | 联系人姓名 | Address.contact_name |
| snapshot_phone | 联系电话 | Address.phone |
| snapshot_address | 完整地址 | Province + City + District + Detail |
| snapshot_province | 省份 | Address.province |
| snapshot_city | 城市 | Address.city |
| snapshot_district | 区县 | Address.district |
| snapshot_town | 乡镇街道 | Address.town |

**章节来源**
- [backend/orders/models.py](file://backend/orders/models.py#L35-L42)
- [backend/orders/services.py](file://backend/orders/services.py#L255-L288)

### 支付记录创建

订单创建完成后立即创建支付记录，确保支付流程的完整性：

```mermaid
classDiagram
class Payment {
+id : BigAutoField
+order : ForeignKey
+amount : DecimalField
+method : CharField
+status : CharField
+created_at : DateTimeField
+expires_at : DateTimeField
+logs : JSONField
+create_for_order(order, method, ttl_minutes)
+check_payment_amount(order, amount)
}
class Order {
+id : BigAutoField
+status : CharField
+total_amount : DecimalField
+payments : RelatedManager
}
Payment --> Order : "belongs to"
```

**图表来源**
- [backend/orders/models.py](file://backend/orders/models.py#L186-L234)

**章节来源**
- [backend/orders/models.py](file://backend/orders/models.py#L186-L234)
- [backend/orders/views.py](file://backend/orders/views.py#L189-L194)

## 订单状态机

### 状态转换规则

订单状态机定义了严格的订单状态转换规则，确保业务逻辑的正确性：

```mermaid
stateDiagram-v2
[*] --> pending : 创建订单
pending --> paid : 支付成功
pending --> cancelled : 用户取消
paid --> shipped : 管理员发货
paid --> refunded : 申请退款
paid --> cancelled : 支付后取消
shipped --> completed : 订单完成
shipped --> refunded : 申请退款
completed --> refunded : 售后退款
refunded --> paid : 退款取消
cancelled --> [*]
completed --> [*]
refunded --> [*]
```

**图表来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L33-L56)

### 状态转换约束

系统严格控制状态转换的合法性：

| 当前状态 | 允许转换到的状态 | 业务逻辑说明 |
|---------|----------------|-------------|
| pending | paid, cancelled | 待支付订单可以支付成功或取消 |
| paid | shipped, refunded, cancelled | 已支付订单可以发货、退款或取消 |
| shipped | completed, refunded | 已发货订单可以完成或退款 |
| completed | refunded | 已完成订单只能申请售后退款 |
| refunded | paid | 退款完成后可以恢复支付状态 |
| cancelled, refunded | 无 | 终态状态不允许进一步转换 |

**章节来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L33-L56)

### 状态转换业务逻辑

状态转换过程中会触发相应的业务逻辑：

```mermaid
flowchart TD
A["状态转换请求"] --> B["验证转换合法性"]
B --> C{"转换合法?"}
C --> |否| D["抛出ValueError"]
C --> |是| E["执行预处理逻辑"]
E --> F["更新订单状态"]
F --> G["记录状态历史"]
G --> H["执行后处理逻辑"]
H --> I["更新商品销量"]
H --> J["释放库存"]
H --> K["发送通知"]
I --> L["返回更新后的订单"]
```

**图表来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L95-L154)

**章节来源**
- [backend/orders/state_machine.py](file://backend/orders/state_machine.py#L95-L154)

## 支付生命周期管理

### 支付服务架构

支付服务负责处理支付流程的各个环节，包括签名验证、金额校验、状态更新等：

```mermaid
classDiagram
class PaymentService {
+verify_callback_signature(data, signature, secret) bool
+check_payment_amount(order, amount) bool
+process_payment_success(payment_id, transaction_id, operator) Payment
+validate_payment_creation(order, payment_amount) tuple
+log_payment_event(payment_id, event, details, error) void
}
class Payment {
+id : BigAutoField
+order : ForeignKey
+amount : DecimalField
+method : CharField
+status : CharField
+logs : JSONField
}
PaymentService --> Payment : "manages"
```

**图表来源**
- [backend/orders/payment_service.py](file://backend/orders/payment_service.py#L20-L292)

### 支付回调处理

支付回调是支付流程的重要环节，系统需要验证回调的真实性和安全性：

```mermaid
sequenceDiagram
participant Provider as "支付提供商"
participant Callback as "PaymentCallbackView"
participant Service as "PaymentService"
participant StateMachine as "OrderStateMachine"
participant DB as "数据库"
Provider->>Callback : POST /api/payments/callback/wechat
Callback->>Callback : 验证签名
alt 签名验证失败
Callback-->>Provider : 返回403
else 签名验证成功
Callback->>Service : process_payment_success()
Service->>DB : SELECT FOR UPDATE
Service->>Service : 检查支付状态
alt 支付已成功
Service-->>Callback : 返回现有支付记录
else 支付未处理
Service->>StateMachine : transition(order, 'paid')
Service->>DB : 更新支付状态
Service-->>Callback : 返回成功支付记录
end
end
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L1134-L1294)
- [backend/orders/payment_service.py](file://backend/orders/payment_service.py#L106-L204)

### 支付安全机制

系统实现了多层次的安全防护：

| 安全措施 | 实现方式 | 目的 |
|---------|----------|------|
| 签名验证 | HMAC-SHA256算法 | 验证回调数据的真实性 |
| 金额校验 | 精确decimal比较 | 确保支付金额准确无误 |
| 幂等处理 | 基于支付ID的重复检查 | 防止重复处理支付回调 |
| 事务控制 | 数据库事务保证原子性 | 确保支付状态的一致性 |
| 过期检查 | TTL机制 | 防止过期支付的处理 |

**章节来源**
- [backend/orders/payment_service.py](file://backend/orders/payment_service.py#L30-L292)
- [backend/orders/views.py](file://backend/orders/views.py#L1134-L1294)

## 商品搜索算法

### 搜索服务架构

商品搜索服务提供了强大的搜索、过滤和排序功能：

```mermaid
classDiagram
class ProductSearchService {
+DEFAULT_PAGE_SIZE : int
+MAX_PAGE_SIZE : int
+VALID_SORT_OPTIONS : set
+search(keyword, category, brand, min_price, max_price, sort_by, page, page_size, user) dict
+get_hot_keywords(limit, days) list
+get_search_suggestions(prefix, limit) list
-_apply_sorting(queryset, sort_by, keyword) queryset
-_log_search(keyword, user) void
}
class Product {
+name : CharField
+description : TextField
+price : DecimalField
+sales_count : IntegerField
+view_count : IntegerField
+created_at : DateTimeField
}
ProductSearchService --> Product : "searches"
```

**图表来源**
- [backend/catalog/search.py](file://backend/catalog/search.py#L19-L287)

### 关键词搜索算法

搜索算法支持模糊匹配和相关性排序：

```mermaid
flowchart TD
A["关键词搜索"] --> B["构建模糊查询"]
B --> C["Q(name__icontains) OR Q(description__icontains)"]
C --> D["应用其他过滤条件"]
D --> E["计算相关性分数"]
E --> F["按相关性排序"]
F --> G["应用分页"]
H["相关性计算"] --> I["名称匹配得分: 2分"]
H --> J["描述匹配得分: 1分"]
I --> K["最终排序: 名称匹配 > 销量 > 创建时间"]
J --> K
```

**图表来源**
- [backend/catalog/search.py](file://backend/catalog/search.py#L97-L135)

### 排序逻辑

系统支持多种排序策略：

| 排序选项 | 排序依据 | 优先级 |
|---------|----------|--------|
| relevance | 关键词相关性 | 主要 |
| price_asc | 价格升序 | 次要 |
| price_desc | 价格降序 | 次要 |
| sales | 销量降序 | 次要 |
| views | 浏览量降序 | 次要 |
| created | 创建时间降序 | 次要 |

**章节来源**
- [backend/catalog/search.py](file://backend/catalog/search.py#L36-L44)
- [backend/catalog/search.py](file://backend/catalog/search.py#L160-L200)

### 搜索建议功能

系统提供智能搜索建议功能：

```mermaid
flowchart TD
A["用户输入关键词"] --> B["提取前缀"]
B --> C["从商品名称搜索"]
B --> D["从搜索历史搜索"]
C --> E["去重合并结果"]
D --> E
E --> F["按频率排序"]
F --> G["返回前N个建议"]
```

**图表来源**
- [backend/catalog/search.py](file://backend/catalog/search.py#L248-L282)

**章节来源**
- [backend/catalog/search.py](file://backend/catalog/search.py#L46-L287)

## 用户认证与资料更新

### 用户服务架构

用户服务提供了完整的用户管理功能：

```mermaid
classDiagram
class UserService {
+get_or_create_wechat_user(openid) tuple
+grant_admin_on_debug_code(code, user, debug) bool
+update_last_login(user) void
+create_tokens_for_user(user) tuple
+bootstrap_or_init_admin(username, password) User
+ensure_user_password(user, password) void
}
class User {
+openid : CharField
+username : CharField
+is_staff : BooleanField
+is_superuser : BooleanField
+last_login_at : DateTimeField
}
UserService --> User : "manages"
```

**图表来源**
- [backend/users/services.py](file://backend/users/services.py#L1-55)

### 微信用户认证

系统支持微信OAuth认证：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "UserService"
participant DB as "数据库"
participant WeChat as "微信服务器"
Client->>WeChat : 发送授权码
WeChat-->>Client : 返回access_token
Client->>WeChat : 使用access_token获取用户信息
WeChat-->>Client : 返回openid和用户信息
Client->>Service : get_or_create_wechat_user(openid)
Service->>DB : 查询用户是否存在
alt 用户不存在
Service->>DB : 创建新用户
Service-->>Client : 返回新用户
else 用户已存在
Service-->>Client : 返回现有用户
end
```

**图表来源**
- [backend/users/services.py](file://backend/users/services.py#L5-L6)

### 管理员权限管理

系统提供了灵活的管理员权限管理机制：

| 功能 | 实现方式 | 触发条件 |
|------|----------|----------|
| 调试模式授权 | debug_code检查 | DEBUG=True且code以'admin'开头 |
| 自动初始化 | bootstrap_or_init_admin | 首次运行且无管理员账户 |
| 密码设置 | ensure_user_password | 用户首次登录且无密码 |
| 登录时间更新 | update_last_login | 每次成功登录 |

**章节来源**
- [backend/users/services.py](file://backend/users/services.py#L1-55)

## API视图调用关系

### 视图层架构

API视图层负责处理HTTP请求并协调各个服务组件：

```mermaid
classDiagram
class OrderViewSet {
+create_order(request) Response
+cancel(request, pk) Response
+ship(request, pk) Response
+complete(request, pk) Response
+push_to_haier(request, pk) Response
+haier_logistics(request, pk) Response
+create_batch_orders(request) Response
+my_orders(request) Response
}
class PaymentCallbackView {
+post(request, provider) Response
-_find_payment(data) Payment
-_verify_signature(provider, data, signature) bool
-_map_payment_status(provider, status) str
}
class CartViewSet {
+my_cart(request) Response
+add_item(request) Response
+remove_item(request) Response
+update_item(request) Response
+clear(request) Response
}
OrderViewSet --> OrderServices : "uses"
PaymentCallbackView --> PaymentService : "uses"
CartViewSet --> CartServices : "uses"
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L23-L800)

### 请求处理流程

以订单创建为例，展示完整的调用链路：

```mermaid
sequenceDiagram
participant Client as "前端客户端"
participant View as "OrderViewSet"
participant Serializer as "OrderCreateSerializer"
participant Service as "OrderService"
participant StateMachine as "OrderStateMachine"
participant DB as "数据库"
Client->>View : POST /api/orders/create_order
View->>Serializer : 验证请求数据
Serializer-->>View : 验证通过
View->>Service : create_order(user, product_id, address_id, quantity)
Service->>DB : 检查库存
Service->>DB : 锁定库存
Service->>DB : 创建订单
Service->>DB : 创建支付记录
Service-->>View : 返回订单对象
View->>StateMachine : 更新订单状态
View-->>Client : 返回订单和支付信息
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L136-L217)

### 异常处理集成

视图层与异常处理机制紧密集成：

```mermaid
flowchart TD
A["视图方法调用"] --> B["业务逻辑执行"]
B --> C{"发生异常?"}
C --> |ValueError| D["记录警告日志"]
C --> |其他异常| E["记录错误日志"]
D --> F["返回400 Bad Request"]
E --> G["返回500 Internal Server Error"]
F --> H["统一异常格式"]
G --> H
H --> I["返回客户端"]
```

**图表来源**
- [backend/orders/views.py](file://backend/orders/views.py#L198-L207)

**章节来源**
- [backend/orders/views.py](file://backend/orders/views.py#L23-L800)

## 异常处理机制

### 异常体系架构

系统建立了完整的异常处理体系：

```mermaid
classDiagram
class BusinessException {
<<abstract>>
+status_code : int
+error_code : str
+__init__(detail, code, error_code)
}
class InsufficientStockError {
+status_code : 409
+error_code : "INSUFFICIENT_STOCK"
}
class InvalidOrderStatusError {
+status_code : 400
+error_code : "INVALID_ORDER_STATUS"
}
class PaymentVerificationError {
+status_code : 400
+error_code : "PAYMENT_VERIFICATION_FAILED"
}
class DuplicatePaymentError {
+status_code : 409
+error_code : "DUPLICATE_PAYMENT"
}
BusinessException <|-- InsufficientStockError
BusinessException <|-- InvalidOrderStatusError
BusinessException <|-- PaymentVerificationError
BusinessException <|-- DuplicatePaymentError
```

**图表来源**
- [backend/common/exceptions.py](file://backend/common/exceptions.py#L26-L230)

### 统一异常处理器

系统实现了统一的异常处理机制：

```mermaid
flowchart TD
A["异常发生"] --> B["自定义异常处理器"]
B --> C["提取错误信息"]
C --> D["构建统一响应格式"]
D --> E{"生产环境?"}
E --> |是| F["隐藏详细错误信息"]
E --> |否| G["包含详细错误信息"]
F --> H["返回客户端"]
G --> H
H --> I["记录日志"]
```

**图表来源**
- [backend/common/exceptions.py](file://backend/common/exceptions.py#L251-L396)

### 异常分类与处理

| 异常类型 | HTTP状态码 | 错误代码 | 处理方式 |
|---------|-----------|----------|----------|
| InsufficientStockError | 409 | INSUFFICIENT_STOCK | 返回库存不足信息，提示用户重新选择 |
| InvalidOrderStatusError | 400 | INVALID_ORDER_STATUS | 返回状态转换错误，提示合法状态 |
| PaymentVerificationError | 400 | PAYMENT_VERIFICATION_FAILED | 返回支付验证失败，提示重新支付 |
| DuplicatePaymentError | 409 | DUPLICATE_PAYMENT | 返回重复支付错误，提示用户不要重复操作 |
| SupplierAPIError | 502 | SUPPLIER_API_ERROR | 返回供应商API错误，提示稍后重试 |

**章节来源**
- [backend/common/exceptions.py](file://backend/common/exceptions.py#L26-L230)

## 总结

本文档全面分析了电商小程序项目的核心业务逻辑实现，涵盖了以下关键方面：

### 核心业务特性

1. **订单创建流程**：实现了严格的库存检查、快照生成和支付记录创建的原子性操作
2. **状态机设计**：通过状态机模式确保订单状态转换的合法性和业务逻辑的正确性
3. **支付安全**：实现了多层次的支付安全保障机制，包括签名验证、金额校验和幂等处理
4. **搜索优化**：提供了智能的商品搜索算法，支持关键词匹配、过滤和排序功能
5. **用户管理**：实现了完整的用户认证和权限管理体系

### 架构设计亮点

1. **服务层分离**：清晰的服务层设计使得业务逻辑易于维护和扩展
2. **异常处理**：完善的异常处理机制确保系统的稳定性和用户体验
3. **事务控制**：关键业务操作采用数据库事务保证数据一致性
4. **并发安全**：通过数据库行锁和状态机确保并发环境下的数据安全

### 技术实现优势

1. **可扩展性**：模块化的设计便于功能扩展和系统升级
2. **可维护性**：清晰的代码结构和完善的异常处理提高了代码的可维护性
3. **性能优化**：合理的索引设计和查询优化提升了系统性能
4. **安全性**：多重安全防护机制保障了系统的安全性

这套业务逻辑设计充分体现了现代电商系统的核心需求，为构建稳定、高效、安全的电商业务平台奠定了坚实的基础。