# 管理命令与数据同步

<cite>
**本文档引用的文件**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py)
- [haierapi.py](file://backend/integrations/haierapi.py)
- [models.py](file://backend/catalog/models.py)
- [integrations/models.py](file://backend/integrations/models.py)
- [storage.py](file://backend/catalog/storage.py)
- [views.py](file://backend/catalog/views.py)
- [serializers.py](file://backend/catalog/serializers.py)
- [logging_config.py](file://backend/common/logging_config.py)
- [base.py](file://backend/backend/settings/base.py)
</cite>

## 目录
1. [概述](#概述)
2. [项目架构](#项目架构)
3. [核心组件分析](#核心组件分析)
4. [命令执行流程](#命令执行流程)
5. [API交互机制](#api交互机制)
6. [数据同步逻辑](#数据同步逻辑)
7. [图片本地化存储](#图片本地化存储)
8. [错误处理与重试机制](#错误处理与重试机制)
9. [日志记录与监控](#日志记录与监控)
10. [配置管理](#配置管理)
11. [生产环境部署](#生产环境部署)
12. [故障排除指南](#故障排除指南)

## 概述

本文档详细介绍了一个基于Django管理命令的商品数据同步系统，专门用于从海尔API获取商品数据、图片资源和库存信息，并将其同步到本地数据库。该系统具备完善的错误处理机制、事务管理和增量同步功能，确保数据的一致性和可靠性。

### 主要特性

- **多维度数据同步**：支持商品基本信息、价格信息、库存信息的同步
- **智能图片处理**：自动下载并本地化存储商品图片，使用UUID命名避免冲突
- **健壮的错误处理**：完善的异常捕获和重试机制
- **灵活的配置管理**：支持多种环境配置和动态参数调整
- **详细的日志记录**：全面的执行日志和审计跟踪

## 项目架构

```mermaid
graph TB
subgraph "管理命令层"
CMD[sync_haier_products.py<br/>管理命令]
end
subgraph "API交互层"
API[HaierAPI<br/>海尔API客户端]
CONFIG[HaierConfig<br/>配置管理]
end
subgraph "业务逻辑层"
MODEL[Product<br/>商品模型]
BRAND[Brand<br/>品牌模型]
CATEGORY[Category<br/>分类模型]
MEDIA[MediaImage<br/>媒体图片模型]
end
subgraph "存储层"
DB[(数据库)]
STORAGE[LocalMediaStorage<br/>本地存储]
end
subgraph "监控层"
LOG[日志系统]
SYNCLOG[HaierSyncLog<br/>同步日志]
end
CMD --> API
CMD --> MODEL
CMD --> BRAND
CMD --> CATEGORY
API --> CONFIG
MODEL --> DB
BRAND --> DB
CATEGORY --> DB
MODEL --> MEDIA
MEDIA --> STORAGE
CMD --> LOG
CMD --> SYNCLOG
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L1-L156)
- [haierapi.py](file://backend/integrations/haierapi.py#L1-L214)
- [models.py](file://backend/catalog/models.py#L1-L312)

## 核心组件分析

### 管理命令组件

管理命令是整个同步系统的核心入口点，负责协调各个组件的工作流程。

```mermaid
classDiagram
class Command {
+help : str
+add_arguments(parser)
+handle(*args, **options)
}
class HaierAPI {
+client_id : str
+client_secret : str
+access_token : str
+authenticate() bool
+get_products(product_codes) List
+get_product_prices(product_codes) List
+check_stock(product_code, county_code) Dict
}
class Product {
+sync_from_haier(haier_data, category, brand) Product
+update_stock_from_haier(stock_data) void
+SOURCE_HAIER : str
+SOURCE_LOCAL : str
}
Command --> HaierAPI : 使用
Command --> Product : 创建/更新
HaierAPI --> Product : 提供数据
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L13-L156)
- [haierapi.py](file://backend/integrations/haierapi.py#L10-L214)
- [models.py](file://backend/catalog/models.py#L118-L195)

### API客户端组件

HaierAPI类封装了与海尔API的所有交互逻辑，提供认证、数据获取和错误处理功能。

```mermaid
sequenceDiagram
participant CMD as 管理命令
participant API as HaierAPI
participant HAIER as 海尔API服务器
CMD->>API : 初始化配置
CMD->>API : authenticate()
API->>HAIER : POST /oauth2/auth
HAIER-->>API : access_token
API-->>CMD : 认证结果
CMD->>API : get_products()
API->>API : _ensure_authenticated()
API->>HAIER : POST /product-info
HAIER-->>API : 商品数据
API-->>CMD : 商品列表
CMD->>API : get_product_prices()
API->>HAIER : POST /price-query
HAIER-->>API : 价格数据
API-->>CMD : 价格信息
CMD->>API : check_stock()
API->>HAIER : POST /stock-check
HAIER-->>API : 库存数据
API-->>CMD : 库存信息
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L50-L156)
- [haierapi.py](file://backend/integrations/haierapi.py#L41-L214)

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L1-L156)
- [haierapi.py](file://backend/integrations/haierapi.py#L1-L214)

## 命令执行流程

### 参数配置

管理命令支持丰富的命令行参数，允许用户精确控制同步行为：

| 参数 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| --product-codes | List[str] | None | 指定要同步的产品编码列表 |
| --category | str | None | 指定商品分类名称 |
| --brand | str | None | 指定品牌名称 |
| --sync-prices | bool | False | 是否同步价格信息 |
| --sync-stock | bool | False | 是否同步库存信息 |
| --county-code | str | "110101" | 区域编码（用于库存查询） |

### 执行步骤

```mermaid
flowchart TD
START([开始执行]) --> INIT_CONFIG[初始化配置]
INIT_CONFIG --> AUTH[认证海尔API]
AUTH --> AUTH_SUCCESS{认证成功?}
AUTH_SUCCESS --> |否| FAIL[执行失败]
AUTH_SUCCESS --> |是| LOAD_CAT[加载分类]
LOAD_CAT --> LOAD_BRAND[加载品牌]
LOAD_BRAND --> QUERY_PROD[查询商品数据]
QUERY_PROD --> HAS_DATA{有商品数据?}
HAS_DATA --> |否| EMPTY[无数据退出]
HAS_DATA --> |是| SYNC_LOOP[遍历商品数据]
SYNC_LOOP --> SYNC_PRICE{同步价格?}
SYNC_PRICE --> |是| FETCH_PRICE[获取价格信息]
SYNC_PRICE --> |否| SYNC_PRODUCT[同步商品]
FETCH_PRICE --> UPDATE_DATA[更新商品数据]
UPDATE_DATA --> SYNC_PRODUCT
SYNC_PRODUCT --> CREATE_OR_UPDATE[创建/更新商品]
CREATE_OR_UPDATE --> UPDATE_SUCCESS{更新成功?}
UPDATE_SUCCESS --> |否| LOG_FAIL[记录失败日志]
UPDATE_SUCCESS --> |是| SYNC_STOCK{同步库存?}
SYNC_STOCK --> |是| FETCH_STOCK[获取库存信息]
SYNC_STOCK --> |否| LOG_SUCCESS[记录成功日志]
FETCH_STOCK --> UPDATE_STOCK[更新库存]
UPDATE_STOCK --> LOG_SUCCESS
LOG_FAIL --> NEXT_ITEM[处理下一个商品]
LOG_SUCCESS --> NEXT_ITEM
NEXT_ITEM --> MORE_ITEMS{还有商品?}
MORE_ITEMS --> |是| SYNC_LOOP
MORE_ITEMS --> |否| SUMMARY[生成总结报告]
SUMMARY --> END([执行结束])
FAIL --> END
EMPTY --> END
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L50-L156)

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L16-L48)

## API交互机制

### 认证流程

海尔API采用OAuth2.0客户端凭据模式进行认证：

```mermaid
sequenceDiagram
participant API as HaierAPI
participant TOKEN as 认证服务器
participant SERVICE as 海尔服务
API->>TOKEN : POST /oauth2/auth
Note over API,TOKEN : client_id + client_secret + grant_type
TOKEN-->>API : access_token + expires_in
API->>API : 设置token_expiry
API->>SERVICE : API请求 + Authorization头
alt token过期
API->>TOKEN : 重新认证
TOKEN-->>API : 新的access_token
end
SERVICE-->>API : API响应
```

**图表来源**
- [haierapi.py](file://backend/integrations/haierapi.py#L41-L64)

### 数据接口

系统调用多个海尔API端点获取不同类型的商品数据：

| 接口类型 | 端点路径 | 功能描述 | 请求参数 |
|----------|----------|----------|----------|
| 商品查询 | `/product-info/procurable-products-out/check-procurable-products` | 获取可采购商品列表 | customerCode, supplierCode, productCodes |
| 价格查询 | `/goods-price/price-daily-sales/price-query/pt-out-list-price` | 获取商品价格信息 | customerCode, productCodes, priceType |
| 库存查询 | `/stock/get-available-stock-open` | 获取可用库存 | salesCode, productCode, countyCode |
| 物流查询 | `/logistics/sass/get-thirdparty-logistics-info-by-order-code-auth` | 获取物流信息 | orderCode, sellerCode |

**章节来源**
- [haierapi.py](file://backend/integrations/haierapi.py#L74-L214)

## 数据同步逻辑

### SKU匹配策略

系统采用多层次的SKU匹配机制确保数据准确性：

```mermaid
flowchart TD
INPUT[输入海尔商品数据] --> CHECK_CODE{检查productCode}
CHECK_CODE --> |缺失| ERROR[返回错误]
CHECK_CODE --> |存在| FIND_PRODUCT[查找本地商品]
FIND_PRODUCT --> EXISTS{商品已存在?}
EXISTS --> |是| UPDATE_EXISTING[更新现有商品]
EXISTS --> |否| CREATE_NEW[创建新商品]
UPDATE_EXISTING --> UPDATE_FIELDS[更新商品字段]
CREATE_NEW --> SET_DEFAULTS[设置默认值]
SET_DEFAULTS --> CREATE_FIELDS[创建商品字段]
UPDATE_FIELDS --> VALIDATE_DATA[验证数据完整性]
CREATE_FIELDS --> VALIDATE_DATA
VALIDATE_DATA --> SUCCESS[同步成功]
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L118-L179)

### 价格更新策略

系统实现了智能的价格更新机制：

| 字段 | 更新规则 | 优先级 |
|------|----------|--------|
| supply_price | 海尔API提供的普通供价 | 最高 |
| invoice_price | 海尔API提供的开票价 | 高 |
| stock_rebate | 海尔API提供的直扣金额 | 中 |
| rebate_money | 海尔API提供的台返金额 | 中 |
| price | 作为最终销售价格 | 最低 |

### 增量同步逻辑

```mermaid
sequenceDiagram
participant CMD as 管理命令
participant LOCAL as 本地数据库
participant REMOTE as 海尔API
CMD->>REMOTE : 获取最新商品列表
REMOTE-->>CMD : 商品编码列表
loop 遍历每个商品
CMD->>LOCAL : 查询本地商品
LOCAL-->>CMD : 本地商品状态
alt 本地不存在
CMD->>REMOTE : 获取完整商品信息
REMOTE-->>CMD : 商品详情
CMD->>LOCAL : 创建新商品
else 本地存在且需要更新
CMD->>REMOTE : 检查数据版本
REMOTE-->>CMD : 最新数据
CMD->>LOCAL : 更新商品信息
else 本地最新
CMD->>CMD : 跳过同步
end
end
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L118-L195)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L116-L142)

**章节来源**
- [models.py](file://backend/catalog/models.py#L118-L195)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L104-L142)

## 图片本地化存储

### 存储架构

系统采用分层的图片存储架构，确保图片的安全性和可访问性：

```mermaid
graph TB
subgraph "前端访问层"
IMG_URL[图片URL]
end
subgraph "存储抽象层"
STORAGE[LocalMediaStorage]
end
subgraph "文件系统层"
MEDIA_ROOT[MEDIA_ROOT目录]
YEAR_DIR[年份子目录]
MONTH_DIR[月份子目录]
DAY_DIR[日期子目录]
FILE[UUID文件名]
end
IMG_URL --> STORAGE
STORAGE --> MEDIA_ROOT
MEDIA_ROOT --> YEAR_DIR
YEAR_DIR --> MONTH_DIR
MONTH_DIR --> DAY_DIR
DAY_DIR --> FILE
```

**图表来源**
- [storage.py](file://backend/catalog/storage.py#L5-L15)
- [views.py](file://backend/catalog/views.py#L773-L792)

### 文件命名策略

系统使用UUID-based的安全文件命名策略：

```mermaid
flowchart LR
NOW[当前时间] --> YEAR[年份目录]
NOW --> MONTH[月份目录]
NOW --> DAY[日期目录]
UUID[UUID.hex] --> FILENAME[文件名]
EXT[文件扩展名] --> FILENAME
YEAR --> MONTH
MONTH --> DAY
DAY --> FILENAME
FILENAME --> FULL_PATH[完整存储路径]
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L773-L792)

### 图片处理流程

```mermaid
sequenceDiagram
participant API as 海尔API
participant CMD as 管理命令
participant VIEW as MediaImageView
participant STORAGE as LocalMediaStorage
participant DB as 数据库
API->>CMD : 返回图片URL列表
CMD->>VIEW : 下载图片
VIEW->>VIEW : 验证文件类型
VIEW->>VIEW : 生成UUID文件名
VIEW->>STORAGE : 保存文件
STORAGE-->>VIEW : 文件路径
VIEW->>DB : 创建MediaImage记录
DB-->>VIEW : 记录ID
VIEW-->>CMD : 图片处理结果
CMD->>CMD : 更新商品图片字段
```

**图表来源**
- [views.py](file://backend/catalog/views.py#L840-L936)
- [serializers.py](file://backend/catalog/serializers.py#L280-L328)

**章节来源**
- [storage.py](file://backend/catalog/storage.py#L1-L15)
- [views.py](file://backend/catalog/views.py#L749-L936)
- [serializers.py](file://backend/catalog/serializers.py#L280-L328)

## 错误处理与重试机制

### 异常分类处理

系统对不同类型的异常采用差异化的处理策略：

```mermaid
flowchart TD
ERROR[发生异常] --> CLASSIFY{异常分类}
CLASSIFY --> NETWORK[网络异常]
CLASSIFY --> AUTH[认证异常]
CLASSIFY --> DATA[数据异常]
CLASSIFY --> SYSTEM[系统异常]
NETWORK --> RETRY[指数退避重试]
AUTH --> REAUTH[重新认证]
DATA --> SKIP[跳过当前项]
SYSTEM --> LOG_ERROR[记录错误日志]
RETRY --> MAX_RETRY{达到最大重试?}
MAX_RETRY --> |否| BACKOFF[等待退避时间]
MAX_RETRY --> |是| LOG_ERROR
BACKOFF --> RETRY
REAUTH --> AUTH_SUCCESS{认证成功?}
AUTH_SUCCESS --> |是| RETRY
AUTH_SUCCESS --> |否| LOG_ERROR
SKIP --> CONTINUE[继续处理]
LOG_ERROR --> CONTINUE
CONTINUE --> END[处理完成]
```

### 日志记录策略

系统实现了分级的日志记录机制：

| 日志级别 | 记录内容 | 触发条件 |
|----------|----------|----------|
| DEBUG | 详细执行信息 | 开发环境 |
| INFO | 关键操作记录 | 生产环境 |
| WARNING | 警告信息 | 可恢复错误 |
| ERROR | 错误信息 | 不可恢复错误 |
| CRITICAL | 严重错误 | 系统级错误 |

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L147-L151)
- [logging_config.py](file://backend/common/logging_config.py#L1-L428)

## 日志记录与监控

### 同步日志模型

系统提供了专门的同步日志模型用于审计和监控：

```mermaid
classDiagram
class HaierSyncLog {
+SYNC_TYPE_CHOICES : List
+STATUS_CHOICES : List
+sync_type : str
+status : str
+message : str
+total_count : int
+success_count : int
+failed_count : int
+started_at : datetime
+completed_at : datetime
+duration() float
}
class SyncTypes {
<<enumeration>>
PRODUCTS
PRICES
STOCK
ORDER
LOGISTICS
MANUAL
}
class StatusTypes {
<<enumeration>>
PENDING
PROCESSING
SUCCESS
FAILED
PARTIAL
}
HaierSyncLog --> SyncTypes
HaierSyncLog --> StatusTypes
```

**图表来源**
- [integrations/models.py](file://backend/integrations/models.py#L50-L150)

### 监控指标

系统收集以下关键性能指标：

| 指标类型 | 指标名称 | 计算方式 | 监控阈值 |
|----------|----------|----------|----------|
| 吞吐量 | 每分钟同步商品数 | 成功同步数/执行时间 | >100商品/分钟 |
| 准确率 | 同步成功率 | 成功数/总数 | >95% |
| 响应时间 | API调用平均延迟 | 总时间/调用次数 | <5秒 |
| 错误率 | 失败率 | 失败数/总数 | <5% |
| 可用性 | 系统可用时间 | 运行时间/总时间 | >99.9% |

**章节来源**
- [integrations/models.py](file://backend/integrations/models.py#L50-L150)

## 配置管理

### 环境配置

系统支持多环境配置管理：

```mermaid
graph LR
subgraph "开发环境"
DEV[development.py]
end
subgraph "生产环境"
PROD[production.py]
end
subgraph "基础配置"
BASE[base.py]
end
subgraph "环境变量"
ENV[EnvironmentConfig]
end
DEV --> BASE
PROD --> BASE
BASE --> ENV
```

**图表来源**
- [base.py](file://backend/backend/settings/base.py#L235-L246)

### 配置参数

| 参数名称 | 环境变量 | 默认值 | 用途 |
|----------|----------|--------|------|
| HAIER_CLIENT_ID | HAIER_CLIENT_ID | '' | 海尔API客户端ID |
| HAIER_CLIENT_SECRET | HAIER_CLIENT_SECRET | '' | 海尔API客户端密钥 |
| HAIER_TOKEN_URL | HAIER_TOKEN_URL | 测试地址 | 认证服务器地址 |
| HAIER_BASE_URL | HAIER_BASE_URL | 测试地址 | API基础URL |
| HAIER_CUSTOMER_CODE | HAIER_CUSTOMER_CODE | '' | 客户编码 |
| HAIER_SEND_TO_CODE | HAIER_SEND_TO_CODE | '' | 发送目标编码 |
| HAIER_SUPPLIER_CODE | HAIER_SUPPLIER_CODE | '' | 供应商编码 |
| HAIER_PASSWORD | HAIER_PASSWORD | '' | 通用密码 |
| HAIER_SELLER_PASSWORD | HAIER_SELLER_PASSWORD | '' | 卖家密码 |

**章节来源**
- [base.py](file://backend/backend/settings/base.py#L235-L246)

## 生产环境部署

### Cron定时任务配置

推荐的cron配置示例：

```bash
# 每天凌晨2点同步商品数据
0 2 * * * /path/to/python /path/to/manage.py sync_haier_products --sync-prices --sync-stock >> /var/log/sync_haier.log 2>&1

# 每小时同步价格信息
0 * * * * /path/to/python /path/to/manage.py sync_haier_products --sync-prices >> /var/log/sync_prices.log 2>&1

# 每30分钟检查库存变化
*/30 * * * * /path/to/python /path/to/manage.py sync_haier_products --sync-stock --county-code 110101 >> /var/log/sync_stock.log 2>&1
```

### 监控建议

1. **健康检查**：定期检查API连接状态
2. **性能监控**：监控同步时间和成功率
3. **容量规划**：跟踪数据增长趋势
4. **告警设置**：
   - 同步失败率超过5%
   - API响应时间超过10秒
   - 磁盘空间不足

### 安全考虑

1. **API密钥保护**：使用环境变量存储敏感信息
2. **网络隔离**：限制API访问的网络范围
3. **访问控制**：仅授权账户可以执行同步命令
4. **审计日志**：记录所有同步操作的详细信息

## 故障排除指南

### 常见问题及解决方案

| 问题类型 | 症状 | 可能原因 | 解决方案 |
|----------|------|----------|----------|
| 认证失败 | "认证失败"错误 | API密钥无效 | 检查环境变量配置 |
| 网络超时 | 请求超时 | 网络连接问题 | 检查网络连通性 |
| 数据不一致 | 同步前后数据不符 | 并发修改冲突 | 实施乐观锁机制 |
| 存储空间不足 | 图片上传失败 | 磁盘空间满 | 清理旧文件 |
| 权限错误 | 文件写入失败 | 目录权限问题 | 检查文件系统权限 |

### 调试技巧

1. **启用调试模式**：设置`DEBUG=True`查看详细错误信息
2. **查看日志文件**：检查`logs/`目录下的各类日志文件
3. **单个商品测试**：使用`--product-codes`参数测试特定商品
4. **分步执行**：分别测试认证、数据获取和存储功能

### 性能优化建议

1. **批量处理**：合理设置`product_codes`参数减少API调用
2. **并发控制**：避免同时运行多个同步任务
3. **缓存策略**：缓存认证令牌减少重复认证
4. **索引优化**：确保数据库表有适当的索引

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L1-L156)
- [logging_config.py](file://backend/common/logging_config.py#L1-L428)