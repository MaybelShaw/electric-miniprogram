# 商品管理

<cite>
**本文档中引用的文件**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx)
- [api.ts](file://merchant/src/services/api.ts)
- [ImageUpload/index.tsx](file://merchant/src/components/ImageUpload/index.tsx)
- [request.ts](file://merchant/src/utils/request.ts)
- [image.ts](file://merchant/src/utils/image.ts)
- [models.py](file://backend/catalog/models.py)
- [serializers.py](file://backend/catalog/serializers.py)
- [views.py](file://backend/catalog/views.py)
- [haierapi.py](file://backend/integrations/haierapi.py)
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py)
- [api.md](file://api.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目架构](#项目架构)
3. [商品列表页面](#商品列表页面)
4. [商品创建和编辑](#商品创建和编辑)
5. [图片上传组件](#图片上传组件)
6. [API接口设计](#api接口设计)
7. [海尔API集成](#海尔api集成)
8. [状态管理和业务逻辑](#状态管理和业务逻辑)
9. [错误处理机制](#错误处理机制)
10. [性能优化策略](#性能优化策略)
11. [总结](#总结)

## 简介

商品管理模块是基于React和Ant Design Pro构建的电商平台核心功能模块，负责商品的全生命周期管理。该模块提供了完整的商品列表展示、搜索筛选、创建编辑、图片上传以及与海尔API的深度集成能力。

### 核心特性
- **商品列表管理**：支持分页、搜索、筛选、排序的完整表格功能
- **商品创建编辑**：基于ModalForm的表单系统，包含丰富的商品属性
- **图片管理**：集成ImageUpload组件，支持主图和详情图的批量上传
- **海尔API集成**：自动同步海尔商品信息，支持价格、库存实时更新
- **状态管理**：完善的商品上下架、库存同步业务逻辑

## 项目架构

商品管理模块采用前后端分离架构，前端基于React + Ant Design Pro，后端使用Django REST Framework。

```mermaid
graph TB
subgraph "前端架构"
A[商品列表页面] --> B[ProTable组件]
C[商品编辑表单] --> D[ModalForm组件]
E[图片上传组件] --> F[ImageUpload组件]
G[API服务层] --> H[请求拦截器]
end
subgraph "后端架构"
I[商品模型] --> J[序列化器]
K[视图控制器] --> L[权限验证]
M[海尔API] --> N[同步服务]
O[库存管理] --> P[日志记录]
end
A --> K
C --> K
E --> K
G --> I
K --> I
```

**图表来源**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx#L1-L50)
- [api.ts](file://merchant/src/services/api.ts#L1-L30)
- [models.py](file://backend/catalog/models.py#L43-L110)

## 商品列表页面

商品列表页面是商品管理的核心入口，基于Ant Design Pro的ProTable组件构建，提供了强大的数据展示和交互功能。

### 表格列配置

商品列表包含以下核心列：

| 列名 | 数据字段 | 类型 | 功能描述 |
|------|----------|------|----------|
| 主图 | main_images | 图片 | 展示商品主图，支持缩略图显示 |
| 产品名称 | name | 文本 | 商品标题，支持单元格省略 |
| 品牌 | brand | 文本 | 品牌名称，支持筛选 |
| 分类 | category | 文本 | 商品分类，支持筛选 |
| 价格 | price | 数字 | 商品价格，格式化显示 |
| 库存 | stock | 数字 | 库存数量，红色标识缺货 |
| 状态 | is_active | 标签 | 上架/下架状态标识 |
| 销量 | sales_count | 数字 | 销售统计，支持排序 |
| 操作 | - | 按钮 | 编辑、删除功能 |

### 搜索和筛选功能

```mermaid
flowchart TD
A[用户输入搜索条件] --> B{选择筛选类型}
B --> |文本搜索| C[模糊匹配商品名称]
B --> |品牌筛选| D[按品牌名称过滤]
B --> |分类筛选| E[按分类名称过滤]
B --> |价格范围| F[设置价格区间]
B --> |状态筛选| G[上架/下架状态]
C --> H[构建查询参数]
D --> H
E --> H
F --> H
G --> H
H --> I[发送API请求]
I --> J[返回筛选结果]
J --> K[更新表格数据]
```

**图表来源**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx#L313-L378)

### 分页和排序机制

系统支持灵活的分页和排序配置：

- **分页配置**：每页20条记录，支持快速跳转和页面大小切换
- **排序功能**：支持按价格、销量、创建时间等字段排序
- **缓存机制**：利用Ant Design Pro的内置缓存提升用户体验

**章节来源**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx#L380-L410)

## 商品创建和编辑

商品创建和编辑功能基于Ant Design Pro的ModalForm组件实现，提供了完整的商品信息录入和管理能力。

### 表单布局设计

```mermaid
classDiagram
class ProductForm {
+string name
+number brand_id
+number category_id
+string source
+number price
+number stock
+string description
+string[] main_images
+string[] detail_images
+boolean is_active
+validateForm() boolean
+handleSubmit() Promise
+handleCancel() void
}
class HaierFields {
+string product_code
+string product_model
+string product_group
+number supply_price
+number invoice_price
+string warehouse_code
+string warehouse_grade
+string is_sales
+string no_sales_reason
}
class LocalFields {
+number market_price
+number stock_rebate
+number rebate_money
}
ProductForm --> HaierFields : "海尔商品"
ProductForm --> LocalFields : "本地商品"
```

**图表来源**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx#L483-L716)

### 表单验证规则

系统实现了严格的表单验证机制：

| 字段 | 验证规则 | 错误提示 |
|------|----------|----------|
| 产品名称 | 必填，长度限制 | 请输入产品名称 |
| 品牌 | 必选 | 请选择品牌 |
| 分类 | 必选 | 请选择分类 |
| 价格 | 必填，非负数，保留两位小数 | 请输入有效价格 |
| 库存 | 必填，非负整数 | 请输入库存数量 |
| 图片 | 文件类型检查，大小限制 | 图片格式不正确或过大 |

### 海尔商品特殊处理

对于海尔来源的商品，系统提供了特殊的处理逻辑：

- **只读字段**：海尔产品编码、型号、价格等字段在编辑时设为只读
- **自动同步**：海尔商品的价格、库存信息由系统自动同步更新
- **状态控制**：海尔商品的状态由API自动控制，不允许手动修改

**章节来源**
- [Products/index.tsx](file://merchant/src/pages/Products/index.tsx#L472-L716)

## 图片上传组件

ImageUpload组件是商品管理的重要组成部分，提供了专业级的图片上传和管理功能。

### 组件架构设计

```mermaid
sequenceDiagram
participant User as 用户
participant Component as ImageUpload组件
participant API as 图片上传API
participant Backend as 后端服务
User->>Component : 选择图片文件
Component->>Component : 文件类型和大小验证
Component->>API : 上传图片文件
API->>Backend : 处理文件存储
Backend-->>API : 返回图片URL
API-->>Component : 响应图片信息
Component->>Component : 更新文件列表
Component->>User : 显示上传成功
```

**图表来源**
- [ImageUpload/index.tsx](file://merchant/src/components/ImageUpload/index.tsx#L73-L122)

### 图片处理功能

ImageUpload组件具备以下核心功能：

| 功能 | 实现方式 | 限制 |
|------|----------|------|
| 文件验证 | 类型检查、大小限制 | 仅支持图片文件，最大20MB |
| 预览功能 | Modal弹窗预览 | 支持大图查看 |
| 批量上传 | 多文件选择 | 支持同时上传多个文件 |
| 实时更新 | 编辑时立即保存 | 上传或删除图片后自动同步 |
| 压缩优化 | 前端预处理 | 保持图片质量的同时减小体积 |

### 与后端的交互流程

```mermaid
flowchart TD
A[用户上传图片] --> B[文件验证]
B --> C{验证通过?}
C --> |否| D[显示错误信息]
C --> |是| E[调用uploadImage API]
E --> F[FormData传输]
F --> G[后端文件处理]
G --> H[生成图片URL]
H --> I[返回图片信息]
I --> J[更新组件状态]
J --> K[通知父组件]
K --> L[刷新商品列表]
```

**图表来源**
- [ImageUpload/index.tsx](file://merchant/src/components/ImageUpload/index.tsx#L73-L122)
- [api.ts](file://merchant/src/services/api.ts#L36-L50)

**章节来源**
- [ImageUpload/index.tsx](file://merchant/src/components/ImageUpload/index.tsx#L1-L173)

## API接口设计

商品管理模块的API设计遵循RESTful原则，提供了完整的CRUD操作和特殊业务功能。

### 核心API接口

| 接口 | 方法 | 功能描述 | 参数 |
|------|------|----------|------|
| `/products/` | GET | 获取商品列表 | search, category, brand, price_range, page, page_size |
| `/products/` | POST | 创建新商品 | 商品基础信息和图片数据 |
| `/products/{id}/` | GET | 获取商品详情 | 商品ID |
| `/products/{id}/` | PUT/PATCH | 更新商品信息 | 商品ID和更新数据 |
| `/products/{id}/` | DELETE | 删除商品 | 商品ID |
| `/media-images/` | POST | 上传图片 | 文件和关联信息 |

### 请求响应格式

```mermaid
classDiagram
class ProductResponse {
+number id
+string name
+string category
+string brand
+number price
+number stock
+string description
+boolean is_active
+string[] main_images
+string[] detail_images
+string source
+number sales_count
+number view_count
+DateTime created_at
+DateTime updated_at
}
class PaginationResponse {
+ProductResponse[] results
+number total
+number page
+number total_pages
+boolean has_next
+boolean has_previous
}
class ErrorResponse {
+string message
+number status
+object details
}
ProductResponse --> PaginationResponse : "分页响应"
ProductResponse --> ErrorResponse : "错误响应"
```

**图表来源**
- [api.ts](file://merchant/src/services/api.ts#L29-L34)
- [serializers.py](file://backend/catalog/serializers.py#L50-L84)

### 错误处理机制

系统实现了多层次的错误处理：

1. **网络层错误**：统一的请求拦截器处理网络异常
2. **业务层错误**：API返回标准化的错误信息
3. **UI层反馈**：友好的用户提示和错误恢复机制

**章节来源**
- [api.ts](file://merchant/src/services/api.ts#L1-L66)
- [request.ts](file://merchant/src/utils/request.ts#L1-L38)

## 海尔API集成

商品管理模块与海尔API的深度集成为商家提供了强大的供应链管理能力。

### 同步机制设计

```mermaid
sequenceDiagram
participant Admin as 管理员
participant Frontend as 前端界面
participant Backend as 后端服务
participant HaierAPI as 海尔API
participant Database as 数据库
Admin->>Frontend : 触发商品同步
Frontend->>Backend : 发送同步请求
Backend->>HaierAPI : 获取商品数据
HaierAPI-->>Backend : 返回商品信息
Backend->>Database : 保存商品数据
Database-->>Backend : 确认保存
Backend-->>Frontend : 返回同步结果
Frontend-->>Admin : 显示同步状态
```

**图表来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L112-L142)
- [haierapi.py](file://backend/integrations/haierapi.py#L1-L50)

### 商品同步流程

系统支持多种同步类型：

| 同步类型 | 功能描述 | 更新内容 |
|----------|----------|----------|
| 商品同步 | 获取海尔商品基本信息 | 名称、描述、价格、图片等 |
| 价格同步 | 更新商品价格信息 | 供价、开票价、市场价 |
| 库存同步 | 实时更新库存数量 | 库存数量、仓库信息 |
| 订单推送 | 将订单推送到海尔系统 | 订单详情、物流信息 |

### 数据映射关系

```mermaid
erDiagram
HAIER_PRODUCT {
string productCode PK
string productModel
string productBrandName
number supplyPrice
number invoicePrice
string productImageUrl
string isSales
string noSalesReason
}
LOCAL_PRODUCT {
string product_code PK
string name
string brand_name
number supply_price
number invoice_price
string product_image_url
string is_sales
string no_sales_reason
}
HAIER_PRODUCT ||--|| LOCAL_PRODUCT : "同步映射"
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L118-L179)
- [views.py](file://backend/catalog/views.py#L464-L494)

**章节来源**
- [sync_haier_products.py](file://backend/catalog/management/commands/sync_haier_products.py#L112-L142)
- [haierapi.py](file://backend/integrations/haierapi.py#L1-L50)

## 状态管理和业务逻辑

商品管理模块实现了复杂的状态管理和业务逻辑处理。

### 商品状态流转

```mermaid
stateDiagram-v2
[*] --> 下架状态
下架状态 --> 上架状态 : 管理员操作
上架状态 --> 下架状态 : 管理员操作
上架状态 --> 销售中 : 用户购买
销售中 --> 完成 : 订单完成
完成 --> 上架状态 : 重新上架
上架状态 --> 库存不足 : 库存耗尽
库存不足 --> 上架状态 : 补充库存
```

### 库存管理策略

系统实现了精细化的库存管理：

| 状态 | 描述 | 影响 |
|------|------|------|
| 库存充足 | stock > 0 | 商品可正常销售 |
| 库存紧张 | stock <= 10 | 显示库存告警 |
| 库存不足 | stock = 0 | 自动下架商品 |
| 库存同步 | last_sync_at | 记录最后同步时间 |

### 业务规则实现

```mermaid
flowchart TD
A[商品操作] --> B{操作类型}
B --> |创建商品| C[验证必填字段]
B --> |更新商品| D[检查商品来源]
B --> |删除商品| E[确认操作权限]
C --> F[保存商品信息]
D --> G{海尔商品?}
G --> |是| H[只读字段保护]
G --> |否| I[允许字段修改]
E --> J[软删除标记]
F --> K[更新索引]
H --> K
I --> K
J --> K
```

**图表来源**
- [models.py](file://backend/catalog/models.py#L84-L110)
- [views.py](file://backend/catalog/views.py#L464-L501)

**章节来源**
- [models.py](file://backend/catalog/models.py#L84-L312)
- [views.py](file://backend/catalog/views.py#L464-L501)

## 错误处理机制

商品管理模块实现了全面的错误处理机制，确保系统的稳定性和用户体验。

### 错误分类体系

```mermaid
graph TD
A[错误处理] --> B[网络错误]
A --> C[业务错误]
A --> D[用户错误]
B --> B1[连接超时]
B --> B2[服务器错误]
B --> B3[认证失败]
C --> C1[数据验证错误]
C --> C2[权限不足]
C --> C3[资源不存在]
D --> D1[表单验证失败]
D --> D2[文件上传失败]
D --> D3[操作取消]
```

### 错误处理策略

| 错误类型 | 处理策略 | 用户体验 |
|----------|----------|----------|
| 网络异常 | 自动重试机制 | 显示加载状态 |
| 数据验证 | 实时校验提示 | 表单内错误提示 |
| 权限问题 | 跳转登录页面 | 友好错误提示 |
| 业务异常 | 详细错误信息 | 明确的操作指导 |

### 日志记录机制

系统实现了完整的日志记录：

- **操作日志**：记录所有商品操作的详细信息
- **错误日志**：捕获和记录系统错误
- **性能日志**：监控API响应时间和系统性能

**章节来源**
- [request.ts](file://merchant/src/utils/request.ts#L23-L37)
- [models.py](file://backend/catalog/models.py#L267-L312)

## 性能优化策略

商品管理模块采用了多种性能优化策略，确保良好的用户体验。

### 前端优化

1. **虚拟滚动**：大数据量表格的虚拟滚动实现
2. **懒加载**：图片和组件的懒加载机制
3. **缓存策略**：本地缓存常用数据
4. **防抖节流**：搜索和筛选的防抖处理

### 后端优化

1. **数据库索引**：为常用查询字段建立索引
2. **查询优化**：使用select_related和prefetch_related
3. **缓存机制**：Redis缓存热点数据
4. **异步处理**：图片上传和同步任务异步执行

### 性能监控

```mermaid
graph LR
A[性能监控] --> B[响应时间]
A --> C[并发处理]
A --> D[资源使用]
B --> B1[API响应时间]
B --> B2[页面加载时间]
C --> C1[最大并发数]
C --> C2[队列长度]
D --> D1[内存使用率]
D --> D2[CPU使用率]
```

## 总结

商品管理模块是一个功能完整、架构清晰的电商核心功能模块。它成功地整合了前端React技术栈、后端Django框架以及第三方海尔API，为企业提供了强大的商品管理能力。

### 核心优势

1. **功能完整性**：涵盖了商品管理的全部核心功能
2. **用户体验优秀**：基于Ant Design Pro的现代化界面设计
3. **扩展性强**：模块化设计便于功能扩展
4. **稳定性高**：完善的错误处理和性能优化机制

### 技术特色

- **前后端分离**：清晰的职责划分和接口设计
- **API集成**：深度集成海尔API，实现供应链自动化
- **图片处理**：专业的图片上传和管理功能
- **状态管理**：完善的商品状态和业务逻辑处理

该模块为电商平台的商品管理提供了坚实的技术基础，能够满足现代电商业务对商品管理的各种需求。