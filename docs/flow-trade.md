## 交易链路（微信支付 & 信用支付）

区分角色：普通用户（小程序）、经销商（商户端）；区分支付：微信/信用；区分商品：本地商品/海尔商品；区分处理：自动/人工。

```mermaid
flowchart TD
    subgraph User[普通用户：小程序]
        A[下单\n创建订单] --> A1{商品类型?}
        A1 -->|本地商品| B{支付方式?}
        A1 -->|海尔商品| B
        B -->|微信| C[创建支付记录\n/payments/]
        B -->|信用| D[选择信用支付\n付款方式=credit]
        C --> E[微信下单\n统一下单JSAPI]
        E --> F{调用微信支付}
        F -->|成功| G[微信回调\n支付成功]
        F -->|失败/取消| H[支付未完成\n可重试]
        G --> I[订单状态=paid]
        D --> J[订单状态=paid\n（信用记账）]

        I --> K{发货后?}
        J --> K
        K -->|否，想退款| L[取消并退款]
        K -->|已发货| M[申请退货/确认收货]
        L --> L1{支付方式?}
        L1 -->|微信| L2[自动发起微信退款\n状态=refunding]
        L1 -->|信用 未发货| L3[自动冲减信用\n退款完成]
        L1 -->|信用 已发货| L4[提示人工处理]

        M -->|退货审批通过| N[填写退货物流/验收]
        N --> O{支付方式?}
        O -->|微信| O1[自动发起退款]
        O -->|信用| O2[人工退款/标记]
        O1 --> P[退款成功\n订单=refunded]
        O2 --> P
    end

    subgraph WeChat[微信支付平台]
        E -.-> WXPay[JSAPI支付]
        WXPay -.回调.-> G
        L2 -.退款API.-> WXRefund[微信退款接口]
        WXRefund -.回调.-> Q[退款回调处理]
    end

    subgraph Backend[后端]
        G --> I
        Q --> P
        A1 -.海尔商品订单推送.-> H1[易理货/海尔接口\n（管理员操作）]
        H1 -.订单同步/取消同步.-> I
    end

    subgraph Merchant[经销商/商户端]
        R[订单列表] --> S{状态?}
        S -->|退款中| T[重试微信退款/查看退款详情]
        S -->|信用 paid/shipped| U[信用退款/标记退款\n需人工确认]
        S -->|退货流程| V[处理退货/验收/完成退款]
        S -->|海尔订单| W[推送/取消同步海尔\n人工]
    end
```

### 关键节点说明
- **支付结果确认**：支付结果页在展示成功前会调用 `/payments/{id}/sync/` 确认 `payment.status == succeeded`。
- **取消并退款**：
  - 微信支付：未发货/已支付取消会自动发起微信退款（状态 `refunding`），失败会通知用户。
  - 信用支付：未发货取消自动冲减信用；已发货需人工处理，前端提示，商户端提供“信用退款/标记退款”按钮。
- **退货退款**：发货/完成后可申请退货，经商户端验收后发起退款（微信走接口，信用需人工）。
- **商户端**：
  - 退款中可重试退款并查看退款详情（当前取最近记录，建议后续支持选择具体退款）。
  - 信用退款入口用于人工确认退款/标记完成。
  - 海尔订单需人工推送/取消同步。
